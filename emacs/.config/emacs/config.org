:DOC-CONFIG:
#+PROPERTY: header-args:emacs-lisp :tangle (concat (file-name-sans-extension (buffer-file-name)) ".el")
#+PROPERTY: header-args :mkdirp yes :comments no
#+startup: fold
:END:

#+begin_src emacs-lisp :exports none
  ;;; config.el --- Configure emacs -*- lexical-binding:t -*-

  ;;; Commentary:

  ;; DO NOT EDIT THIS FILE DIRECTLY
  ;; This is a file generated from a literate programming source file located at
  ;; https://github.com/emilknievel/dotfiles/blob/main/emacs/.config/emacs/config.org
  ;; You should make any changes there and regenerate it from Emacs org-mode using C-c C-v t

  ;;; Code:
#+end_src

#+TITLE: Emacs Config
#+AUTHOR: Emil VÃ¥gstedt
#+EMAIL: emil.vagstedt@icloud.com
#+OPTIONS: toc:t

** Better defaults
Opinionated default [[https://git.sr.ht/~technomancy/better-defaults][settings]].

#+begin_src emacs-lisp
  (unless (or (fboundp 'helm-mode) (fboundp 'ivy-mode))
    (ido-mode t)
    (setq ido-enable-flex-matching t))

  (unless (memq window-system '(mac ns))
    (menu-bar-mode -1))
  (when (fboundp 'tool-bar-mode)
    (tool-bar-mode -1))
  (when (fboundp 'scroll-bar-mode)
    (scroll-bar-mode -1))
  (when (fboundp 'horizontal-scroll-bar-mode)
    (horizontal-scroll-bar-mode -1))

  (autoload 'zap-up-to-char "misc"
    "Kill up to, but not including ARGth occurrence of CHAR." t)

  (require 'uniquify)
  (setq uniquify-buffer-name-style 'forward)

  ;; https://www.emacswiki.org/emacs/SavePlace
  (save-place-mode 1)

  (global-set-key (kbd "M-/") 'hippie-expand)
  (global-set-key (kbd "C-x C-b") 'ibuffer)
  (global-set-key (kbd "M-z") 'zap-up-to-char)

  (global-set-key (kbd "C-s") 'isearch-forward-regexp)
  (global-set-key (kbd "C-r") 'isearch-backward-regexp)
  (global-set-key (kbd "C-M-s") 'isearch-forward)
  (global-set-key (kbd "C-M-r") 'isearch-backward)

  (show-paren-mode 1)
  (setq-default indent-tabs-mode nil)
  (savehist-mode 1)
  (setq save-interprogram-paste-before-kill t
        apropos-do-all t
        mouse-yank-at-point t
        require-final-newline t
        ;; visible-bell t
        load-prefer-newer t
        backup-by-copying t
        frame-inhibit-implied-resize t
        ediff-window-setup-function 'ediff-setup-windows-plain
        custom-file (expand-file-name "custom.el" user-emacs-directory))

  (unless backup-directory-alist
    (setq backup-directory-alist `(("." . ,(concat user-emacs-directory
                                                   "backups")))))
#+end_src

** Calendar
*** Weeks start on Mondays
#+begin_src emacs-lisp
  (setq calendar-week-start-day 1)
#+end_src

** Environment variables
*** Get OS shell variables
#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :config
    (setq exec-path-from-shell-variables '("PATH"
                                           "TERM_THEME"
                                           "WSL_DISTRO_NAME"
                                           "DOTNET_ROOT"
                                           "XDG_CONFIG_HOME"
                                           "FUNCTIONS_CORE_TOOLS_TELEMETRY_OPTOUT"
                                           "OPAM_SWITCH_PREFIX"
                                           "CAML_LD_LIBRARY"
                                           "OCAML_TOPLEVEL_PATH"
                                           "BUN_INSTALL"
                                           "NODE_EXTRA_CA_CERTS"))
    (exec-path-from-shell-initialize)
    :when (or (memq window-system '(mac ns x)) (daemonp)))
#+end_src

*** Emacs specific
#+begin_src emacs-lisp
  (setenv "LANG" "en_US.UTF-8")
#+end_src

** Security
Integrate Emacs with GnuTLS to ensure trusted connections.

#+begin_src emacs-lisp
  (use-package gnutls
    :defer t
    :custom
    (gnutls-verify-error t))
#+end_src

*** Secrets
**** 1Password auth source
#+begin_src emacs-lisp
  (use-package auth-source-1password
    :config (auth-source-1password-enable))
#+end_src

** Key bindings
*** which-key
#+begin_src emacs-lisp
  (use-package which-key
    :diminish
    :init
    (which-key-mode)
    (which-key-setup-minibuffer)
    :config
    (setq which-key-idle-delay 0.3))
#+end_src

*** general.el
general.el provides a more convenient, unified interface for binding keys in Emacs.
Check [[https://github.com/noctuid/general.el#reading-recommendations][this section]] in the repo for recommended reading before configuring with general.el.

Keymaps using ~<SPC>~ as leader are defined with ~general-define-key~ with ~:prefix-map 'ev/leader-key-map~.

**** Preamble
#+begin_src emacs-lisp
  (use-package general
    :init
    (global-unset-key (kbd "C-M-SPC"))
    :after evil
    :config
    (general-evil-setup t)
    (general-define-key
     :keymaps '(normal insert emacs)
     :prefix "SPC"
     :non-normal-prefix "C-M-SPC"
     :prefix-map 'ev/leader-key-map

     ;; Top level functions
     "SPC" '(execute-extended-command :wk "M-x")

     ;; Prefixes

     "a" '(:ignore t :wk "AI")
     "a c" '(:ignore t :wk "Copilot")
     "b" '(:ignore t :wk "Buffer")
     "c" '(:ignore t :wk "Code")
     "d" '(:ignore t :wk "Directory")
     "E" '(:ignore t :wk "Embark")
     "f" '(:ignore t :wk "File")
     "f c" '(:ignore t :wk "Config")
     "g" '(:ignore t :wk "Git")
     "h" '(:ignore t :wk "Help")
     "n" '(:ignore t :wk "Note")
     "n r" '(:ignore t :wk "Roam")
     "o" '(:ignore t :wk "Org")
     "o b" '(:ignore t :wk "Babel")
     "p" '(:ignore t :wk "Project")
     "q" '(:ignore t :wk "Quit")
     "s" '(:ignore t :wk "Search")
     "t" '(:ignore t :wk "Toggle")
     "u" '(:ignore t :wk "UI")
     "u l" '(:ignore t :wk "Linum")
     "u f" '(:ignore t :wk "Fonts")))
#+end_src

**** Files
#+begin_src emacs-lisp
  (defun ev/reload-emacs-config ()
    "Tangle org file and reload the emacs config."
    (interactive)
    (org-babel-tangle-file (expand-file-name "config.org" user-emacs-directory))
    (load-file (expand-file-name "config.el" user-emacs-directory)))

  (defun ev/edit-emacs-config ()
    "Edit Emacs literate config file."
    (interactive)
    (find-file (expand-file-name "config.org" user-emacs-directory)))

  (general-define-key
   :prefix-map 'ev/leader-key-map
   "f c r" 'ev/reload-emacs-config
   "f c f" 'ev/edit-emacs-config
   "f f" 'find-file
   "f l" 'load-file
   "f s" 'save-buffer)
#+end_src

**** Buffers
#+begin_src emacs-lisp
  (general-define-key
   :prefix-map 'ev/leader-key-map
   ;; buffers
   "b" '(nil :wk "buffers")
   "b b" 'switch-to-buffer
   "b B" 'ibuffer
   "b X" 'scratch-buffer
   "q q" 'save-buffers-kill-terminal
   "b r" 'revert-buffer-quick)
#+end_src

**** Help
#+begin_src emacs-lisp
  (general-define-key
   :prefix-map 'ev/leader-key-map
   ;; help
   "h f" 'describe-function
   "h v" 'describe-variable
   "h k" 'describe-key
   "h i" 'info
   "h b" 'describe-bindings
   "h a" 'describe-face)
#+end_src

**** Toggles
#+begin_src emacs-lisp
  (general-define-key
   :prefix-map 'ev/leader-key-map
   ;; toggles
   "t v" '(visual-line-mode :wk "visual line mode")
   "t n" '(display-line-numbers-mode :wk "display line numbers")
   "t c" '(visual-fill-column-mode :wk "visual fill column mode"))
#+end_src

**** UI
#+begin_src emacs-lisp
  (general-define-key
   :prefix-map 'ev/leader-key-map
   "u f v" 'variable-pitch-mode
   "u f b" 'ev/big-font-size
   "u f +" 'ev/increase-font-size
   "u f -" 'ev/decrease-font-size
   "u f 0" 'ev/reset-font-size)
#+end_src

**** Emacs Client
#+begin_src emacs-lisp
  (general-define-key
   :prefix-map 'ev/leader-key-map
   ;; emacsclient
   "q k" '(save-buffers-kill-emacs :wk "Kill emacsclient process"))
#+end_src

*** Evil
Use Evil mode for Vim like bindings.

#+begin_src emacs-lisp
  (use-package undo-fu)

  (use-package evil
    :after general
    :bind (("<escape>" . keyboard-escape-quit))
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-undo-system 'undo-fu)
    (setq evil-want-C-u-scroll t)
    :general
    (ev/leader-key-map
     "w" '(:keymap evil-window-map :wk "Window"))
    :config
    (evil-define-key 'normal org-mode-map (kbd "TAB") #'org-cycle)
    (evil-mode 1))

  (use-package evil-collection
    :after evil
    :custom (evil-collection-setup-minibuffer t) ; enable evil in the minibuffer
    :config
    (evil-collection-init)
    :hook (vterm-mode . evil-collection-vterm-escape-stay))

  (use-package evil-commentary
    :hook (prog-mode . evil-commentary-mode))

  (use-package evil-surround
    :after evil
    :hook ((org-mode . (lambda () (push '(?~ . ("~" . "~")) evil-surround-pairs-alist)))
           (org-mode . (lambda () (push '(?$ . ("\\(" . "\\)")) evil-surround-pairs-alist))))
    :config
    (global-evil-surround-mode 1))
#+end_src

** Editing
*** iedit
Edit multiple occurrences in the same way simultaneously.

#+begin_src emacs-lisp
  (use-package iedit
    :general
    (ev/leader-key-map "e" 'iedit-mode))
#+end_src

Integrate iedit with evil. [[https://github.com/syl20bnr/evil-iedit-state][Keybindings]] etc.

#+begin_src emacs-lisp
  (use-package evil-iedit-state)
#+end_src

*** Whitespace
Show trailing whitespace.

#+begin_src emacs-lisp
  (require 'whitespace)
#+end_src

*** Expand region
Increase selected region by /semantic units/.

#+begin_src emacs-lisp
  (use-package expand-region
    :general (ev/leader-key-map "=" 'er/expand-region))
#+end_src

*** Vundo
Visual undo. Displays the undo history as a tree and lets you move in the tree to go back to previous buffer states.

Invoked with ~M-x vundo~ or ~<leader> c u~.

#+begin_src emacs-lisp
  (use-package vundo
    :general (ev/leader-key-map "c u" 'vundo))
#+end_src

** Customization
*** Disable startup screen
Get rid of the annoying startup screen.

#+begin_src emacs-lisp
  (setq inhibit-startup-screen t)
#+end_src

*** Confirm on exit
#+begin_src emacs-lisp
  (setopt confirm-kill-emacs 'y-or-n-p)
#+end_src

*** macOS
#+begin_src emacs-lisp
  (setq ns-use-proxy-icon nil
        ns-use-mwheel-momentum t
        ns-use-mwheel-acceleration t
        frame-resize-pixelwise t
        mac-command-modifier 'meta
        mac-right-command-modifier 'none
        mac-option-modifier nil
        mac-control-modifier 'control)
#+end_src

*** Theme
**** Themes directory
#+begin_src emacs-lisp
  (setq custom-theme-directory "~/.config/emacs/themes/")
#+end_src

**** Modus themes
#+begin_src emacs-lisp
  (use-package modus-themes
    :ensure t
    :custom
    (modus-themes-mixed-fonts t)
    (modus-themes-org-blocks 'gray-background)
    (modus-themes-common-palette-overrides
     '((fringe unspecified)
       (bg-paren-match bg-magenta-intense)
       (fg-heading-1 blue-warmer)
       (fg-heading-2 yellow-cooler)
       (fg-heading-3 cyan-cooler)))
    (modus-themes-headings
     '((1 . (1.5))
       (2 . (1.4))
       (3 . (1.3))
       (4 . (1.2))
       (5 . (1.1))
       (6 . (1.0))
       (7 . (1.0))
       (8 . (1.0))))
    (modus-themes-variable-pitch-ui t))
    ;; :config
    ;; ;; TODO: manually set org code blocks to match modus theme look on protiselaos' website
    ;; (load-theme 'modus-vivendi :no-confirm)
    ;; (general-define-key
    ;;  :prefix-map 'ev/leader-key-map
    ;;  "t t" '(modus-themes-toggle :wk "Toggle theme")))
#+end_src

**** Ef themes
#+begin_src emacs-lisp
  (use-package ef-themes
    :custom
    (ef-themes-mixed-fonts t)
    (ef-themes-common-palette-overrides
     '((fringe unspecified)))
    (ef-themes-headings
     '((1 . (1.5))
       (2 . (1.4))
       (3 . (1.3))
       (4 . (1.2))
       (5 . (1.1))
       (6 . (1.0))
       (7 . (1.0))
       (8 . (1.0))))
    (ef-themes-variable-pitch-ui t)
    (ef-themes-to-toggle '(ef-dark ef-light))
    (ef-themes-mixed-fonts t)
    :config
    (load-theme 'ef-dark :no-confirm)
    :general (ev/leader-key-map
              "t t" 'ef-themes-toggle))
#+end_src

**** Auto-Dark for Emacs
#+begin_src emacs-lisp
  (if (and (display-graphic-p) (not (getenv "WSL_DISTRO_NAME")))
      (use-package auto-dark
        :diminish
        :init
        (setq auto-dark-dark-theme 'ef-dark
              auto-dark-light-theme 'ef-light)
        :config
        (auto-dark-mode t))
    ;; load according to terminal theme if running inside terminal
    (if (string= (getenv "TERM_THEME") "light")
        (load-theme 'ef-light :no-confirm)
      (load-theme 'ef-dark :no-confirm)))
#+end_src

*** Fonts
**** Font variables
#+begin_src emacs-lisp
  (defvar ev/linux-font "Iosevka Comfy")
  (defvar ev/macos-font "Iosevka Comfy")

  (if (eq system-type 'darwin)
      (defvar ev/editor-font ev/macos-font)
    (defvar ev/editor-font ev/linux-font))

  (if (eq system-type 'darwin)
      (progn (defvar ev/default-font ev/editor-font)
             (defvar ev/variable-pitch-font "Iosevka Comfy Motion Duo"))
    (progn (defvar ev/default-font ev/editor-font)
           (defvar ev/variable-pitch-font "Iosevka Comfy Motion Duo")))
#+end_src

**** Setup editor fonts
#+begin_src emacs-lisp
  (if (eq system-type 'darwin)
      (progn (setq ev/variable-pitch-font-height 140)
             (setq ev/editor-font-height 140)
             (setq ev/fixed-pitch-font-height 140))
    (progn (setq ev/variable-pitch-font-height 110)
           (setq ev/editor-font-height 110)
           (setq ev/fixed-pitch-font-height 110)))

  (set-face-attribute 'default nil :family ev/editor-font :height ev/editor-font-height)
  (set-face-attribute 'fixed-pitch nil :family ev/editor-font :height ev/fixed-pitch-font-height)
  (set-face-attribute 'variable-pitch nil :family ev/variable-pitch-font :height ev/variable-pitch-font-height)
  (set-face-attribute 'italic nil :slant 'italic :underline nil)

  (defun ev/big-font-size ()
    (interactive)
    (set-face-attribute 'default nil :family ev/editor-font :height (+ ev/editor-font-height 30))
    (set-face-attribute 'fixed-pitch nil :family ev/editor-font :height (+ ev/fixed-pitch-font-height 30))
    (set-face-attribute 'variable-pitch nil :family ev/variable-pitch-font :height (+ ev/variable-pitch-font-height 30)))

    (defun ev/increase-font-size ()
      (interactive)
      (set-face-attribute 'default nil :height (ceiling (* 1.1 (face-attribute 'default :height))))
      (set-face-attribute 'fixed-pitch nil :height (ceiling (* 1.1 (face-attribute 'fixed-pitch :height))))
      (set-face-attribute 'variable-pitch nil :height (ceiling (* 1.1 (face-attribute 'variable-pitch :height)))))

    (defun ev/decrease-font-size ()
      (interactive)
      (set-face-attribute 'default nil :height (max 1 (floor (* 0.9 (face-attribute 'default :height)))))
      (set-face-attribute 'fixed-pitch nil :height (max 1 (floor (* 0.9 (face-attribute 'fixed-pitch :height)))))
      (set-face-attribute 'variable-pitch nil :height (max 1 (floor (* 0.9 (face-attribute 'variable-pitch :height))))))

    (defun ev/reset-font-size ()
      (interactive)
      (set-face-attribute 'default nil :height ev/editor-font-height)
      (set-face-attribute 'fixed-pitch nil :height ev/fixed-pitch-font-height)
      (set-face-attribute 'variable-pitch nil :height ev/variable-pitch-font-height))
#+end_src

**** Custom faces
#+begin_src emacs-lisp
  (custom-theme-set-faces
   'user
   `(markdown-inline-code-face ((t (:inherit org-code))))
   `(markdown-code-face ((t (:inherit fixed-pitch :family ,ev/editor-font))))
   `(org-document-title ((t (:inherit outline-1 :height 1.1 :weight bold)))))
#+end_src

**** Ligatures
Display ligatures. Disabled by default. Enable with ~<leader> u f l~ =(ui->fonts->ligatures)=.

#+begin_src emacs-lisp
  (use-package ligature
    :straight
    (ligature :type git :host github :repo "mickeynp/ligature.el")
    :config
    (setq liga '("|||>" "<|||" "<==>" "<!--" "####" "~~>" "***" "||=" "||>"
                 ":::" "::=" "=:=" "===" "==>" "=!=" "=>>" "=<<" "=/=" "!=="
                 "!!." ">=>" ">>=" ">>>" ">>-" ">->" "->>" "-->" "---" "-<<"
                 "<~~" "<~>" "<*>" "<||" "<|>" "<$>" "<==" "<=>" "<=<" "<->"
                 "<--" "<-<" "<<=" "<<-" "<<<" "<+>" "</>" "###" "#_(" "..<"
                 "..." "+++" "/==" "///" "_|_" "www" "&&" "^=" "~~" "~@" "~="
                 "~>" "~-" "**" "*>" "*/" "||" "|}" "|]" "|=" "|>" "|-" "{|"
                 "[|" "]#" "::" ":=" ":>" ":<" "$>" "==" "=>" "!=" "!!" ">:"
                 ">=" ">>" ">-" "-~" "-|" "->" "--" "-<" "<~" "<*" "<|" "<:"
                 "<$" "<=" "<>" "<-" "<<" "<+" "</" "#{" "#[" "#:" "#=" "#!"
                 "##" "#(" "#?" "#_" "%%" ".=" ".-" ".." ".?" "+>" "++" "?:"
                 "?=" "?." "??" ";;" "/*" "/=" "/>" "//" "__" "~~" "(*" "*)"
                 "\\\\" "://"))
    (ligature-set-ligatures 'prog-mode liga)
    (ligature-set-ligatures 'org-mode liga)
    :general
    (ev/leader-key-map
     "u f l" 'global-ligature-mode))
#+end_src

*** Column indication
Show column indicator at column 80.

#+begin_src emacs-lisp
  (defun ev/show-column-guide ()
    (setq display-fill-column-indicator-column 80)
    (display-fill-column-indicator-mode))

  (add-hook 'prog-mode-hook #'ev/show-column-guide)
#+end_src

*** Display line numbers
Hooks for relative and absolute line numbers.

#+begin_src emacs-lisp
  (defun ev/display-set-relative ()
    (interactive)
    (if (not (or (eq major-mode 'org-mode) (eq major-mode 'vterm-mode) (eq major-mode 'markdown-mode) (eq major-mode 'gfm-mode)))
        (setq display-line-numbers 'visual)
      (setq display-line-numbers nil)))

  (defun ev/display-set-absolute ()
    (interactive)
    (if (not (or (eq major-mode 'org-mode) (eq major-mode 'vterm-mode) (eq major-mode 'markdown-mode) (eq major-mode 'gfm-mode)))
        (setq display-line-numbers t)
      (setq display-line-numbers nil)))

  (defun ev/display-set-hidden ()
    (interactive)
    (setq display-line-numbers nil))
#+end_src

Turn on line numbers for program and configuration modes.

#+begin_src emacs-lisp
  (use-package display-line-numbers
    :custom
    (display-line-numbers-widen t)
    (display-line-numbers-type 'visual)
    :hook
    ((prog-mode conf-mode) . display-line-numbers-mode)
    (evil-insert-state-entry . ev/display-set-absolute)
    (evil-insert-state-exit . ev/display-set-relative)
    ;; :config
    ;; (add-hook 'evil-insert-state-entry-hook #'ev/display-set-absolute)
    ;; (add-hook 'evil-insert-state-exit-hook #'ev/display-set-relative)
    :general
    (ev/leader-key-map
     "u l h" 'ev/display-set-hidden
     "u l r" 'ev/display-set-relative
     "u l a" 'ev/display-set-absolute))
#+end_src

*** Whitespace
Show trailing whitespace in buffer.

#+begin_src emacs-lisp
  (setq show-trailing-whitespace t)
#+end_src

Add a newline to the end of the file if one doesn't already exist.

#+begin_src emacs-lisp
  (setq require-final-newline t)
#+end_src

*** Icons
Install the icons with ~M-x nerd-icons-install-fonts~.

#+begin_src emacs-lisp
  (use-package nerd-icons)
#+end_src

Nerd icons for dired.

#+begin_src emacs-lisp
  (use-package nerd-icons-dired
    :hook ((dired-mode . nerd-icons-dired-mode)
           ;; prevent icons from overlapping vertically
           (dired-mode . (lambda () (setq line-spacing 0.25)))))
#+end_src

*** Modeline
**** Display cursor column
#+begin_src emacs-lisp
  (column-number-mode 1)
#+end_src

**** Diminish
Declutter the modeline.

#+begin_src emacs-lisp
  (use-package diminish
    :config
    (diminish 'visual-line-mode))
#+end_src

*** Padding
#+begin_src emacs-lisp
  (use-package spacious-padding
    :config
    (spacious-padding-mode 1))
#+end_src

** Completion
*** Nerd Icons Completion
#+begin_src emacs-lisp
  (use-package nerd-icons-completion
    :after (marginalia nerd-icons)
    :hook (marginalia-mode . nerd-icons-completion-marginalia-setup)
    :init
    (nerd-icons-completion-mode))
#+end_src

*** Marginalia
#+begin_src emacs-lisp
  (use-package marginalia
    :after vertico
    :general
    (:keymaps 'minibuffer-local-map
              "M-a" 'marginalia-cycle)
    :custom
    (marginalia-max-relative-age 0)
    (marginalia-align 'right)
    (marginalia-annotators '(marginalia-annotators-heavy marginalia-annotators-light nil))
    :init
    (marginalia-mode))
#+end_src

*** Vertico
#+begin_src emacs-lisp
  (use-package vertico
    :demand t                             ; Otherwise won't get loaded immediately
    :straight (vertico :files (:defaults "extensions/*") ; Special recipe to load extensions conveniently
                       :includes (vertico-indexed
                                  vertico-flat
                                  vertico-grid
                                  vertico-mouse
                                  vertico-quick
                                  vertico-buffer
                                  vertico-repeat
                                  vertico-reverse
                                  vertico-directory
                                  vertico-multiform
                                  vertico-unobtrusive
                                  ))
    :general
    (:keymaps '(normal insert visual motion)
              "M-." #'vertico-repeat
              )
    (:keymaps 'vertico-map
              "<tab>" #'vertico-insert ; Set manually otherwise setting `vertico-quick-insert' overrides this
              "<escape>" #'minibuffer-keyboard-quit
              "?" #'minibuffer-completion-help
              "C-M-n" #'vertico-next-group
              "C-M-p" #'vertico-previous-group
              ;; Multiform toggles
              "<backspace>" #'vertico-directory-delete-char
              "C-w" #'vertico-directory-delete-word
              "C-<backspace>" #'vertico-directory-delete-word
              "RET" #'vertico-directory-enter
              "C-i" #'vertico-quick-insert
              "C-o" #'vertico-quick-exit
              "M-o" #'kb/vertico-quick-embark
              "M-G" #'vertico-multiform-grid
              "M-F" #'vertico-multiform-flat
              "M-R" #'vertico-multiform-reverse
              "M-U" #'vertico-multiform-unobtrusive
              "C-l" #'kb/vertico-multiform-flat-toggle
              )
    :hook ((rfn-eshadow-update-overlay . vertico-directory-tidy) ; Clean up file path when typing
           (minibuffer-setup . vertico-repeat-save) ; Make sure vertico state is saved
           )
    :custom
    (vertico-count 13)
    (vertico-resize t)
    (vertico-cycle nil)
    ;; Extensions
    (vertico-grid-separator "       ")
    (vertico-grid-lookahead 50)
    (vertico-buffer-display-action '(display-buffer-reuse-window))
    (vertico-multiform-categories
     '((file reverse)
       (consult-grep buffer)
       (consult-location)
       (imenu buffer)
       (library reverse indexed)
       (org-roam-node reverse indexed)
       (t reverse)
       ))
    (vertico-multiform-commands
     '(("flyspell-correct-*" grid reverse)
       (org-refile grid reverse indexed)
       (consult-yank-pop indexed)
       (consult-flycheck)
       (consult-lsp-diagnostics)
       ))
    :init
    (defun kb/vertico-multiform-flat-toggle ()
      "Toggle between flat and reverse."
      (interactive)
      (vertico-multiform--display-toggle 'vertico-flat-mode)
      (if vertico-flat-mode
          (vertico-multiform--temporary-mode 'vertico-reverse-mode -1)
        (vertico-multiform--temporary-mode 'vertico-reverse-mode 1)))
    (defun kb/vertico-quick-embark (&optional arg)
      "Embark on candidate using quick keys."
      (interactive)
      (when (vertico-quick-jump)
        (embark-act arg)))

    ;; Workaround for problem with `tramp' hostname completions. This overrides
    ;; the completion style specifically for remote files! See
    ;; https://github.com/minad/vertico#tramp-hostname-completion
    (defun kb/basic-remote-try-completion (string table pred point)
      (and (vertico--remote-p string)
           (completion-basic-try-completion string table pred point)))
    (defun kb/basic-remote-all-completions (string table pred point)
      (and (vertico--remote-p string)
           (completion-basic-all-completions string table pred point)))
    (add-to-list 'completion-styles-alist
                 '(basic-remote           ; Name of `completion-style'
                   kb/basic-remote-try-completion kb/basic-remote-all-completions nil))
    :config
    (vertico-mode)
    ;; Extensions
    (vertico-multiform-mode)

    ;; Prefix the current candidate with âÂ» â. From
    ;; https://github.com/minad/vertico/wiki#prefix-current-candidate-with-arrow
    (advice-add #'vertico--format-candidate :around
                (lambda (orig cand prefix suffix index _start)
                  (setq cand (funcall orig cand prefix suffix index _start))
                  (concat
                   (if (= vertico--index index)
                       (propertize "Â» " 'face 'vertico-current)
                     "  ")
                   cand))))
#+end_src

*** Orderless
#+begin_src emacs-lisp
  (use-package orderless
    :custom
    (completion-styles '(orderless))
    (completion-category-defaults nil)    ; I want to be in control!
    (completion-category-overrides
     '((file (styles basic-remote ; For `tramp' hostname completion with `vertico'
                     orderless
                     ))
       ))

    (orderless-component-separator 'orderless-escapable-split-on-space)
    (orderless-matching-styles
     '(orderless-literal
       orderless-prefixes
       orderless-initialism
       orderless-regexp
       ;; orderless-flex
       ;; orderless-strict-leading-initialism
       ;; orderless-strict-initialism
       ;; orderless-strict-full-initialism
       ;; orderless-without-literal          ; Recommended for dispatches instead
       ))
    (orderless-style-dispatchers
     '(prot-orderless-literal-dispatcher
       prot-orderless-strict-initialism-dispatcher
       prot-orderless-flex-dispatcher
       ))
    :init
    (defun orderless--strict-*-initialism (component &optional anchored)
      "Match a COMPONENT as a strict initialism, optionally ANCHORED.
  The characters in COMPONENT must occur in the candidate in that
  order at the beginning of subsequent words comprised of letters.
  Only non-letters can be in between the words that start with the
  initials.

  If ANCHORED is `start' require that the first initial appear in
  the first word of the candidate.  If ANCHORED is `both' require
  that the first and last initials appear in the first and last
  words of the candidate, respectively."
      (orderless--separated-by
          '(seq (zero-or-more alpha) word-end (zero-or-more (not alpha)))
        (cl-loop for char across component collect `(seq word-start ,char))
        (when anchored '(seq (group buffer-start) (zero-or-more (not alpha))))
        (when (eq anchored 'both)
          '(seq (zero-or-more alpha) word-end (zero-or-more (not alpha)) eol))))

    (defun orderless-strict-initialism (component)
      "Match a COMPONENT as a strict initialism.
  This means the characters in COMPONENT must occur in the
  candidate in that order at the beginning of subsequent words
  comprised of letters.  Only non-letters can be in between the
  words that start with the initials."
      (orderless--strict-*-initialism component))

    (defun prot-orderless-literal-dispatcher (pattern _index _total)
      "Literal style dispatcher using the equals sign as a suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless
  parses its input."
      (when (string-suffix-p "=" pattern)
        `(orderless-literal . ,(substring pattern 0 -1))))

    (defun prot-orderless-strict-initialism-dispatcher (pattern _index _total)
      "Leading initialism  dispatcher using the comma suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless
  parses its input."
      (when (string-suffix-p "," pattern)
        `(orderless-strict-initialism . ,(substring pattern 0 -1))))

    (defun prot-orderless-flex-dispatcher (pattern _index _total)
      "Flex  dispatcher using the tilde suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless
  parses its input."
      (when (string-suffix-p "." pattern)
        `(orderless-flex . ,(substring pattern 0 -1))))
    )
#+end_src

*** Corfu
#+begin_src emacs-lisp
  (use-package corfu
    ;; Optional customizations
    :custom
    (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
    (corfu-auto t)                 ;; Enable auto completion
    (corfu-auto-delay 0.2)
    (corfu-auto-prefix 3)

    ;; (corfu-separator ?\s)          ;; (M-SPC) Orderless field separator
    ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
    (corfu-quit-no-match 'separator)
    ;; (corfu-preview-current nil)    ;; Disable current candidate preview
    ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
    ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
    ;; (corfu-scroll-margin 5)        ;; Use scroll margin

    ;; Enable Corfu only for certain modes.
    ;; :hook ((prog-mode . corfu-mode)
    ;;        (shell-mode . corfu-mode)
    ;;        (eshell-mode . corfu-mode))

    ;; Keybindings
    (global-set-key (kbd "M-n") #'corfu-next)
    (global-set-key (kbd "M-p") #'corfu-previous)
    (global-set-key (kbd "C-M-i") #'corfu-complete)

    ;; Recommended: Enable Corfu globally.
    ;; This is recommended since Dabbrev can be used globally (M-/).
    ;; See also `corfu-exclude-modes'.
    :init
    (global-corfu-mode))

  ;; A few more useful configurations...
  (use-package emacs
    :ensure nil
    :init
    ;; TAB cycle if there are only few candidates
    (setq completion-cycle-threshold 3)

    ;; Emacs 28: Hide commands in M-x which do not apply to the current mode.
    ;; Corfu commands are hidden, since they are not supposed to be used via M-x.
    ;; (setq read-extended-command-predicate
    ;;       #'command-completion-default-include-p)

    (setq tab-always-indent 'complete))
#+end_src

*** Cape
#+begin_src emacs-lisp
  ;; Add extensions
  (use-package cape
    ;; Bind dedicated completion commands
    ;; Alternative prefix keys: C-c p, M-p, M-+, ...
    :bind (("C-c p p" . completion-at-point) ;; capf
           ("C-c p t" . complete-tag)        ;; etags
           ("C-c p d" . cape-dabbrev)        ;; or dabbrev-completion
           ("C-c p h" . cape-history)
           ("C-c p f" . cape-file)
           ("C-c p k" . cape-keyword)
           ("C-c p s" . cape-symbol)
           ("C-c p a" . cape-abbrev)
           ("C-c p l" . cape-line)
           ("C-c p w" . cape-dict)
           ("C-c p \\" . cape-tex)
           ("C-c p _" . cape-tex)
           ("C-c p ^" . cape-tex)
           ("C-c p &" . cape-sgml)
           ("C-c p r" . cape-rfc1345))
    :init
    ;; Add `completion-at-point-functions', used by `completion-at-point'.
    ;; NOTE: The order matters!
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-to-list 'completion-at-point-functions #'cape-elisp-block)
    ;;(add-to-list 'completion-at-point-functions #'cape-history)
    ;;(add-to-list 'completion-at-point-functions #'cape-keyword)
    ;;(add-to-list 'completion-at-point-functions #'cape-tex)
    ;;(add-to-list 'completion-at-point-functions #'cape-sgml)
    ;;(add-to-list 'completion-at-point-functions #'cape-rfc1345)
    ;;(add-to-list 'completion-at-point-functions #'cape-abbrev)
    ;;(add-to-list 'completion-at-point-functions #'cape-dict)
    ;;(add-to-list 'completion-at-point-functions #'cape-symbol)
    ;;(add-to-list 'completion-at-point-functions #'cape-line)
    )
#+end_src

*** Kind-icon
Note: See [[https://github.com/jdtsmith/kind-icon/issues/34#issuecomment-1668560185][this]] post for handling theme changes.

#+begin_src emacs-lisp
  (use-package kind-icon
    :after corfu
    :custom
    (kind-icon-use-icons t)
    (kind-icon-default-face 'corfu-default) ; to compute blended backgrounds correctly
    (kind-icon-blend-background nil)  ; Use midpoint color between foreground and background colors ("blended")?
    (kind-icon-blend-frac 0.08)
    (kind-icon-default-style
     '(:padding -1 :stroke 0 :margin 0 :radius 0 :height 0.5 :scale 1.0))
    (kind-icon-formatted 'variable)
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

*** Snippets
#+begin_src emacs-lisp
  (use-package yasnippet)
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet-snippets
    :after yasnippet
    :ensure t
    :config
    (yas-global-mode 1))
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet-capf
    :after cape
    :config
    (add-to-list 'completion-at-point-functions #'yasnippet-capf))
#+end_src

** Eglot
#+begin_src emacs-lisp
  (use-package eglot)
#+end_src

#+begin_src emacs-lisp
  (use-package flycheck-eglot
    :ensure t
    :after (flycheck eglot)
    :config
    (global-flycheck-eglot-mode 1))
#+end_src

** Language configuration
*** Treesitter
Language grammars.

#+begin_src emacs-lisp
  (setq treesit-language-source-alist
        '((bash "https://github.com/tree-sitter/tree-sitter-bash")
          (cmake "https://github.com/uyha/tree-sitter-cmake")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (elisp "https://github.com/Wilfred/tree-sitter-elisp")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (lua "https://github.com/MunifTanjim/tree-sitter-lua")
          (make "https://github.com/alemuller/tree-sitter-make")
          (markdown "https://github.com/ikatyang/tree-sitter-markdown")
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (toml "https://github.com/tree-sitter/tree-sitter-toml")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")
          (ocaml "https://github.com/tree-sitter/tree-sitter-ocaml" "master" "ocaml/src")
          (c-sharp "https://github.com/tree-sitter/tree-sitter-c-sharp")
          (rust "https://github.com/tree-sitter/tree-sitter-rust")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp/" "master" "src")
          (vue "https://github.com/ikatyang/tree-sitter-vue")))
#+end_src

Install grammars from treesit-language-source-alist with ~(mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist))~.
Call e.g. ~treesit-language-available-p 'python~ to determine if grammar is available for the language.

Show all existing tree-sitter major modes with the apropos help command: ~C-h a -ts-mode$~.

Make Emacs use ts mode when opening the corresponding filetype.

#+begin_src emacs-lisp
  (setq major-mode-remap-alist
        '((bash-mode . bash-ts-mode)
          (cmake-mode . cmake-ts-mode)
          (css-mode . css-ts-mode)
          (elisp-mode . elisp-ts-mode)
          (go-mode . go-ts-mode)
          (html-mode . html-ts-mode)
          (javascript-mode . js-ts-mode)
          (json-mode . json-ts-mode)
          (make-mode . make-ts-mode)
          (python-mode . python-ts-mode)
          (toml-mode . toml-ts-mode)
          (tsx-mode . tsx-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (yaml-mode . yaml-ts-mode)
          (ocaml-mode . ocaml-ts-mode)
          ;; (csharp-mode . csharp-ts-mode)
          (rust-mode . rust-ts-mode)
          (c-mode . c-ts-mode)
          (c++-mode . c++-ts-mode)
          (lua-mode . lua-ts-mode)))
#+end_src

*** Prolog
Use prolog-mode instead of perl-mode for .pl files.

#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.pl?\\'" . prolog-mode))
#+end_src

*** Docker
Docker file mode.

#+begin_src emacs-lisp
  (use-package dockerfile-mode
    :config (put 'dockerfile-image-name 'safe-local-variable #'stringp))
#+end_src

*** YAML
#+begin_src emacs-lisp
  (use-package yaml-mode
    :hook
    (yaml-mode . (lambda ()
                   (define-key yaml-mode-map "\C-m" 'newline-and-indent))))
#+end_src

*** Markdown
#+begin_src emacs-lisp
  (use-package markdown-mode
    :mode ("\\.md\\'" . gfm-mode)
    :init (setq markdown-command "pandoc"
                markdown-header-scaling t
                markdown-enable-math t
                markdown-make-gfm-checkboxes-buttons t
                markdown-fontify-code-blocks-natively t))
#+end_src

*** Clojure
Clojure mode (possibly going to be replaced by clojure-ts-mode sometime in the future.

#+begin_src emacs-lisp
  (use-package clojure-mode)

  (use-package aggressive-indent-mode
    :hook (clojure-mode))

  (use-package smartparens
    :init (require 'smartparens-config)
    :hook (clojure-mode . smartparens-mode))
#+end_src

*** Common Lisp
#+begin_src emacs-lisp
  (use-package sly
    :init (setq inferior-lisp-program (executable-find "sbcl"))
    :mode ("\\.lisp?\\'" . common-lisp-mode)
    :hook
    (sly-mode . (lambda ()
                  (unless (sly-connected-p)
                    (save-excursion (sly))))))
#+end_src

*** Typescript
#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.tsx?\\'" . tsx-ts-mode))
#+end_src

*** Web
#+begin_src emacs-lisp
  (use-package web-mode)
#+end_src

*** jq
Info about interactive use in a JSON buffer, Org-babel support and how to use with yq for yaml provided [[https://github.com/ljos/jq-mode][here]].

#+begin_src emacs-lisp
  (use-package jq-mode
    :mode ("\\.jq\\'" . jq-mode))
#+end_src

*** HTTP
**** restclient.el
This package provides a simple way to interact with RESTful APIs from within Emacs. [[https://emacsrocks.com/e15.html][This]] /Emacs Rocks!/ episode highlights some of its features.

Notable keymaps:

| Keymap  | Command description                                     |
|---------+---------------------------------------------------------|
| =C-c C-c= | Send request at point                                   |
| =C-c C-j= | Run jq interactively on restclient json response buffer |

#+begin_src emacs-lisp
  (use-package restclient
    :mode ("\\.http\\'" . restclient-mode))

  ;; Below makes sure that restclient-jq can be required which
  ;; is a must if we want to be able to use jq related tasks.
  (use-package restclient-jq
    :after restclient
    :config (require 'restclient-jq))
#+end_src

*** Vue
#+begin_src emacs-lisp
  (use-package vue-ts-mode
    :straight '(vue-ts-mode
                :type git
                :host github
                :repo "8uff3r/vue-ts-mode"
                :branch "main")
    :mode ("\\.vue\\'" . vue-ts-mode)
    :config
    (with-eval-after-load 'eglot
      (add-to-list 'eglot-server-programs
                   '(vue-ts-mode . ("vue-language-server" "--stdio"
                                    :initializationOptions
                                    (:typescript (:tsdk "./node_modules/typescript/lib"))))))
    :hook (vue-ts-mode . eglot-ensure))
#+end_src

*** Rust
#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.rs?\\'" . rust-ts-mode))
#+end_src

*** Mermaid
#+begin_src emacs-lisp
  (use-package mermaid-mode :mode "\\.mmd$")
#+end_src

*** Lua
#+begin_src emacs-lisp
  (use-package lua-mode
    :mode "\\.lua\\'")

  (use-package lua-ts-mode
    :config
    (with-eval-after-load 'eglot
      (add-to-list 'eglot-server-programs
                   '((lua-mode lua-ts-mode) . ("lua-language-server"))))
    (add-to-list 'project-vc-extra-root-markers ".busted")
    :hook
    ((lua-mode . lua-ts-mode)
     (lua-ts-mode . eglot-ensure)))
#+end_src

*** C#
#+begin_src emacs-lisp
  ;; Invoke Eglot when entering a C# file
  (with-eval-after-load 'eglot
    (add-to-list 'eglot-server-programs
                 '((csharp-mode csharp-ts-mode) . ("omnisharp" "-lsp"))))
  (add-hook 'csharp-mode-hook 'eglot-ensure)

  ;; C# is fairly verbose, so lines are usually longer than 80 columns
  (add-hook 'csharp-mode-hook
            (lambda () (when (not (= display-fill-column-indicator-column 120))
                         (setq display-fill-column-indicator-column 120))))
#+end_src

** Syntax checking
#+begin_src emacs-lisp
  (use-package flycheck
    :init (global-flycheck-mode))
#+end_src

** Git
*** Magit
#+begin_src emacs-lisp
  (use-package magit
    :general
    (ev/leader-key-map
     "g g" 'magit-status))
#+end_src

*** TODO magit/forge [0/2]
- [ ] Check what it's all about.
- [ ] How does this fit in with my current workflow with eg. github. Does it also have a use in azure devops? Is it comparable with the gh cli tool?

*** diff-hl
#+begin_src emacs-lisp
  (use-package diff-hl
    :init
    (global-diff-hl-mode)
    (diff-hl-flydiff-mode) ; update diff-hl on the fly
    (add-hook 'dired-mode-hook 'diff-hl-dired-mode) ; show diff in dired
    :hook
    (magit-pre-refresh . diff-hl-magit-pre-refresh)
    (magit-post-refresh . diff-hl-magit-post-refresh))
#+end_src

*** TODO Consult-GH [0/1]
- [ ] Research and list how I would use this package. What does it replace in my current github workflow?

** Terminal Emulation
*** Eat
#+begin_src emacs-lisp
  (use-package eat
    :straight (:type git
                     :host codeberg
                     :repo "akib/emacs-eat"
                     :files ("*.el" ("term" "term/*.el") "*.texi"
                             "*.ti" ("terminfo/e" "terminfo/e/*")
                             ("terminfo/65" "terminfo/65/*")
                             ("integration" "integration/*")
                             (:exclude ".dir-locals.el" "*-tests.el")))
    :general (ev/leader-key-map "t e" 'eshell)
    :custom
    (eat-term-name "xterm-256color")
    (eat-kill-buffer-on-exit t)
    :hook ((eshell-load . eat-eshell-mode)
           (eshell-load . eat-eshell-visual-command-mode)))
#+end_src

** Project
#+begin_src emacs-lisp
  (use-package project
    :general
    (ev/leader-key-map
     "p" '(:keymap project-prefix-map :wk "project")) ; leader prefix for built-in project.el
    :straight (:type built-in))
#+end_src
[[https://www.patrickdelliott.com/emacs.d/#org0a74aa5][source]]

** File exploration
*** Dired
#+begin_src emacs-lisp
  (use-package dired
    :straight (:type built-in)
    :general
    (ev/leader-key-map
     "d d" 'dired
     "d j" '(dired-jump :wk "dired jump"))
    :config
    (when (string= system-type "darwin")
      (setq dired-use-ls-dired t
            insert-directory-program "/opt/homebrew/bin/gls"))
    (evil-define-key 'normal dired-mode-map
      "h" 'dired-up-directory
      "l" 'dired-find-file)
    :hook (dired-mode . dired-hide-details-mode)
    :custom
    (dired-listing-switches "-aBhl --group-directories-first"))

  (use-package dired-single)
#+end_src

*** Hide/show hidden files
#+begin_src emacs-lisp
  (use-package dired-hide-dotfiles
    :config
    (evil-define-key 'normal dired-mode-map
      "H" 'dired-hide-dotfiles-mode))
#+end_src

*** Treemacs
Treemacs is an Emacs package that provides a customizable, tree-style file explorer and project manager, streamlining file navigation and organization.

#+begin_src emacs-lisp
  (use-package treemacs
    :defer t
    :general (ev/leader-key-map "f e" 'treemacs))

  (use-package treemacs-evil
    :after (treemacs evil))

  (use-package treemacs-magit
    :after (treemacs magit))

  (use-package treemacs-nerd-icons
    :after (treemacs nerd-icons)
    :config (treemacs-load-theme "nerd-icons"))
#+end_src

*** Consult dir
Jump to previously visited directory, not unlike using =zoxide=.

#+begin_src emacs-lisp
  (use-package consult-dir
    :ensure t
    :bind (("C-x C-d" . consult-dir)
           :map vertico-map
           ("C-x C-d" . consult-dir)
           ("C-x C-j" . consult-dir-jump-file)))

  ;; https://karthinks.com/software/jumping-directories-in-eshell/
  (defun eshell/z (&optional regexp)
    "Navigate to a previously visited directory in eshell, or to
  any directory proferred by `consult-dir'."
    (let ((eshell-dirs (delete-dups
                        (mapcar 'abbreviate-file-name
                                (ring-elements eshell-last-dir-ring)))))
      (cond
       ((and (not regexp) (featurep 'consult-dir))
        (let* ((consult-dir--source-eshell `(:name "Eshell"
                                                   :narrow ?e
                                                   :category file
                                                   :face consult-file
                                                   :items ,eshell-dirs))
               (consult-dir-sources (cons consult-dir--source-eshell
                                          consult-dir-sources)))
          (eshell/cd (substring-no-properties
                      (consult-dir--pick "Switch directory: ")))))
       (t (eshell/cd (if regexp (eshell-find-previous-directory regexp)
                       (completing-read "cd: " eshell-dirs)))))))
#+end_src

** Editorconfig
#+begin_src emacs-lisp
  (use-package editorconfig
    :diminish
    :config (editorconfig-mode 1))
#+end_src

** Search
*** Consult
#+begin_src emacs-lisp
  ;; Example configuration for Consult
  (use-package consult
    :general
    (ev/leader-key-map
     "s g" 'consult-git-grep
     "s s" 'consult-ripgrep
     "s l" 'consult-line
     "s L" 'consult-line-multi)

    ;; Replace bindings. Lazily loaded due by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)
           ("M-s D" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Optionally configure the register formatting. This improves the register
    ;; preview for `consult-register', `consult-register-load',
    ;; `consult-register-store' and the Emacs built-ins.
    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)

    ;; Optionally tweak the register preview window.
    ;; This adds thin lines, sorting and hides the mode line of the window.
    (advice-add #'register-preview :override #'consult-register-window)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

    ;; By default `consult-project-function' uses `project-root' from project.el.
    ;; Optionally configure a different project root function.
    ;;;; 1. project.el (the default)
    ;; (setq consult-project-function #'consult--default-project--function)
    ;;;; 2. vc.el (vc-root-dir)
    ;; (setq consult-project-function (lambda (_) (vc-root-dir)))
    ;;;; 3. locate-dominating-file
    ;; (setq consult-project-function (lambda (_) (locate-dominating-file "." ".git")))
    ;;;; 4. projectile.el (projectile-project-root)
    ;; (autoload 'projectile-project-root "projectile")
    ;; (setq consult-project-function (lambda (_) (projectile-project-root)))
    ;;;; 5. No project support
    ;; (setq consult-project-function nil)
    )
#+end_src

** Org
*** Initial config
#+begin_src emacs-lisp
  (use-package org
    :custom
    (org-return-follows-link t)
    (org-startup-with-inline-images t)
    (org-fontify-quote-and-verse-blocks t)
    (org-image-actual-width '(300))
    (org-pretty-entities t)
    (org-auto-align-tags nil)
    (org-tags-column 0)
    (org-catch-invisible-edits 'show-and-error)
    (org-special-ctrl-a/e t)
    (org-insert-heading-respect-content t)
    (org-ellipsis "â¦")
    (org-log-done 'time) ; Will add CLOSED: [timestamp] line after todo headline when marked as done
    (org-startup-folded 'content) ; show an outline of all headings by default
    :bind (("C-c l" . org-store-link)
           ("C-c a" . org-agenda)
           ("C-c c" . org-capture))
    :hook
    ((org-mode gfm-mode markdown-mode) . variable-pitch-mode)
    ((org-mode gfm-mode markdown-mode) . visual-line-mode)
    :general (ev/leader-key-map "o b t" 'org-babel-tangle))
#+end_src

*** Org Modern
#+begin_src emacs-lisp
  (use-package org-modern
    :after org
    :custom
    (org-modern-table nil)
    (org-modern-todo t)
    (org-modern-star '("*"))
    (org-modern-hide-stars nil)
    (org-modern-block-fringe 8)
    :hook
    (org-mode . org-modern-mode))
#+end_src

*** Olivetti
Olivetti is a minor mode that provides a nice writing environment by setting comfortable window margins etc.

#+begin_src emacs-lisp
  (use-package olivetti
    :diminish
    :general
    (ev/leader-key-map "u o" 'olivetti-mode)
    :init
    (setq olivetti-body-width 120
          olivetti-minimum-body-width 72)
    :config
    :hook ((org-mode markdown-mode) . olivetti-mode))
#+end_src

*** Appear
This package displays hidden emphasis markers while the cursor is on a rich text word.

#+begin_src emacs-lisp
  (use-package org-appear
    :custom
    (org-hide-emphasis-markers t)
    (org-appear-autoemphasis t)
    (org-appear-autolinks t)
    (org-appear-autosubmarkers t)
    (org-appear-autoentities t)
    (org-appear-autokeywords t)
    (org-appear-inside-latex t)
    :hook (org-mode . org-appear-mode))
#+end_src

*** Org Roam
Personal wiki. Org files are synced through [[https://syncthing.net][Syncthing]] and the db is stored locally.
Based on the System Crafters [[https://systemcrafters.net/build-a-second-brain-in-emacs/][Build a Second Brain in Emacs]] show notes.

#+begin_src emacs-lisp
  (use-package org-roam
    :demand t
    :custom
    (org-roam-directory "~/org-roam")
    (org-roam-dailies-directory "journal/")
    (org-roam-completion-everywhere t)

    ;; display tags when searching nodes
    (org-roam-node-display-template
     (concat "${title:*} "
             (propertize "${tags}" 'face 'org-tag)))

    ;; file templates
    (org-roam-capture-templates

     '(("d" "default" plain "%?"
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
        :unnarrowed t)

       ("l" "programming language" plain
        (file "~/org-roam/templates/programming-language-note-template.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+filetags: :programming_language:")
        :unnarrowed t)

       ("b" "book notes" plain
        (file "~/org-roam/templates/book-note-template.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+filetags: :literature:book:")
        :unnarrowed t)

       ("a" "author notes" plain
        (file "~/org-roam/templates/author-notes-template.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+filetags: :literature:author:")
        :unnarrowed t)

       ("p" "project" plain
        (file "~/org-roam/templates/project-template.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+category: ${title}\n#+filetags: :project:")
        :unnarrowed t)
       ))

    ;; Daily note templates
    (org-roam-dailies-capture-templates
     '(("d" "default" entry "* %<%H:%M> %?"
        :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n"))

       ("t" "task" entry "* TODO %?"
        :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n"))
       ))

    :bind
    (("C-c n l" . org-roam-buffer-toggle) ; Backlinks buffer
     ("C-c n f" . org-roam-node-find)
     ("C-c n i" . org-roam-node-insert)
     ("C-c n I" . ev/org-roam-node-insert-immediate)
     :map org-mode-map
     ("C-M-i" . completion-at-point)
     :map org-roam-dailies-map
     ("Y" . org-roam-dailies-capture-yesterday)
     ("T" . org-roam-dailies-capture-tomorrow))
    :bind-keymap
    ("C-c n d" . org-roam-dailies-map)
    :general
    (ev/leader-key-map
     "n r r" 'org-roam-buffer-toggle
     "n r f" 'org-roam-node-find
     "n r i" 'org-roam-node-insert)

    :config
    (require 'org-roam-dailies)
    (org-roam-db-autosync-enable))

#+end_src

**** Org agenda hacks
#+begin_src emacs-lisp
  (defun ev/org-roam-node-insert-immediate (arg &rest args)
    "Fast node insertion based on first item in org-roam-capture-templates"
    (interactive "P")
    (let ((args (cons arg args))
          (org-roam-capture-templates (list (append (car org-roam-capture-templates)
                                                    '(:immediate-finish t)))))
      (apply #'org-roam-node-insert args)))

  (defun ev/org-roam-filter-by-tag (tag-name)
    (lambda (node)
      (member tag-name (org-roam-node-tags node))))

  (defun ev/org-roam-list-notes-by-tag (tag-name)
    (cl-remove-duplicates
     (mapcar
      #'org-roam-node-file
      (seq-filter (ev/org-roam-filter-by-tag tag-name) (org-roam-node-list)))
     :test #'string=))

  (defun ev/org-roam-refresh-agenda-list ()
    (interactive)
    (setq org-agenda-files (ev/org-roam-list-notes-by-tag "project")))

  (ev/org-roam-refresh-agenda-list)
#+end_src

**** Select notes based on tag
#+begin_src emacs-lisp
  (defun ev/org-roam-project-finalize-hook ()
    "Adds the captured project file to `org-agenda-files' if the
    capture was not aborted."
    ;; Remove the hook since it was added temporarily
    (remove-hook 'org-capture-after-finalize-hook #'ev/org-roam-project-finalize-hook)

    ;; Add project file to the agenda list if the capture was confirmed
    (unless org-note-abort
      (with-current-buffer (org-capture-get :buffer)
        (add-to-list 'org-agenda-files (buffer-file-name)))))

  (defun ev/org-roam-find-project ()
    (interactive)
    ;; Add the project file to the agenda after capture is finished
    (add-hook 'org-capture-after-finalize-hook #'ev/org-roam-project-finalize-hook)

    ;; Select a project file to open, creating it if necessary
    (org-roam-node-find
     nil
     nil
     (ev/org-roam-filter-by-tag "project")
     nil
     :templates
     '(("p" "project" plain
        (file "~/org-roam/templates/project-template.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                           "#+title: ${title}\n#+category: ${title}\n#+filetags: :project:")
        :unnarrowed t))))

  (global-set-key (kbd "C-c n p") #'ev/org-roam-find-project)
#+end_src

**** Custom capture tasks
Quickly capture new notes and tasks for later review in the ~Inbox.org~ file.

#+begin_src emacs-lisp
  (defun ev/org-roam-capture-inbox ()
    "Capture a note into inbox."
    (interactive)
    (org-roam-capture- :node (org-roam-node-create)
                       :templates '(("i" "inbox" plain "* %?"
                                     :if-new (file+head "inbox.org" "#+title: Inbox\n")))))

  (global-set-key (kbd "C-c n x") #'ev/org-roam-capture-inbox)
#+end_src

Capture a task directly into a specific project.

#+begin_src emacs-lisp
  (defun ev/org-roam-capture-task ()
    (interactive)
    ;; Add the project file to the agenda after capture is finished
    (add-hook 'org-capture-after-finalize-hook #'ev/org-roam-project-finalize-hook)

    ;; Capture the new task, creating the project file if necessary
    (org-roam-capture- :node (org-roam-node-read
                              nil
                              (ev/org-roam-filter-by-tag "project"))
                       :templates
                       '(("p" "project" plain "** TODO %?"
                          :if-new
                          (file+head+olp "%<%Y%m%d%H%M%S>-${slug}.org"
                                         "#+title: ${title}\n#+category: ${title}\n#+filetags: project"
                                         ("Tasks"))))))

  (global-set-key (kbd "C-c n t") #'ev/org-roam-capture-task)
#+end_src

*** org-roam-ui
Display org roam database as connected nodes in the browser.

#+begin_src emacs-lisp
  (use-package org-roam-ui
    :straight
    (:host github :repo "org-roam/org-roam-ui" :branch "main" :files ("*.el" "out"))
    :after org-roam
    ;;  :hook (after-init . org-roam-ui-mode)
    :config
    (setq org-roam-ui-sync-theme t
          org-roam-ui-follow t
          org-roam-ui-update-on-save t
          org-roam-ui-open-on-start t))
#+end_src

#+begin_src emacs-lisp
  (use-package websocket
    :straight t
    :after org-roam)
#+end_src

*** Org-noter
#+begin_src emacs-lisp
  (use-package org-noter
    :custom
    ;; Directory where org-noter will look for note files if invoked in a
    ;; non-org-roam buffer
    (org-noter-notes-search-path '("~/org/notes"))

    ;; Create highlight in pdf when creating note
    (org-noter-highlight-selected-text t)

    ;; Remember last read location in document
    (org-noter-auto-save-last-location t))
#+end_src

*** Babel
#+begin_src emacs-lisp
  (setq org-confirm-babel-evaluate nil
        org-src-fontify-natively t
        org-src-tab-acts-natively t)

  (defconst load-language-alist
    '((emacs-lisp . t)
      (perl       . t)
      (python     . t)
      (ruby       . t)
      (js         . t)
      (css        . t)
      (sass       . t)
      (C          . t)
      (java       . t)
      (shell      . t)
      (plantuml   . t)
      (lua        . t))
    "Alist of org ob languages.")
  (org-babel-do-load-languages 'org-babel-load-languages
                               load-language-alist)
#+end_src

*** TODO Transclusion
- [ ] Install [[https://github.com/nobiot/org-transclusion][org-transclusion]]

*** TODO Super Agenda
- [ ] Install [[https://github.com/alphapapa/org-super-agenda][org-super-agenda]]

** OCaml
#+begin_src emacs-lisp
  ;; OCaml configuration
  ;;  - better error and backtrace matching

  (defun set-ocaml-error-regexp ()
    (set
     'compilation-error-regexp-alist
     (list '("[Ff]ile \\(\"\\(.*?\\)\", line \\(-?[0-9]+\\)\\(, characters \\(-?[0-9]+\\)-\\([0-9]+\\)\\)?\\)\\(:\n\\(\\(Warning .*?\\)\\|\\(Error\\)\\):\\)?"
             2 3 (5 . 6) (9 . 11) 1 (8 compilation-message-face)))))

  (add-hook 'tuareg-mode-hook 'set-ocaml-error-regexp)
  (add-hook 'caml-mode-hook 'set-ocaml-error-regexp)
#+end_src

** PDF
Use PDF tools package to turn Emacs into a PDF viewer with annotation support etc.

#+begin_src emacs-lisp
  (use-package pdf-tools
    :commands (pdf-loader-install)
    :mode "\\.pdf\\'"
    :bind (:map pdf-view-mode-map
                ("j" . pdf-view-next-line-or-next-page)
                ("k" . pdf-view-previous-line-or-previous-page))
    :init (pdf-loader-install)
    :config (add-to-list 'revert-without-query ".pdf")
    :hook (pdf-view-mode . (lambda () (interactive)
                             (display-line-numbers-mode -1))))
#+end_src

** Embark
Package repo.

#+begin_src emacs-lisp
  (use-package embark
    :bind
    ;; going to need to change some of these in order to make it work nice with EViL etc.
    (("C-." . embark-act)         ;; pick some comfortable binding
     ("C-;" . embark-dwim)        ;; good alternative: M-.
     ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

    :general
    (ev/leader-key-map
     "E E" 'embark-act
     "E h B" 'embark-bindings)

    :init
    ;; Optionally replace the key help with a completing-read interface
    (setq prefix-help-command #'embark-prefix-help-command)

    ;; Show the Embark target at point via Eldoc.  You may adjust the Eldoc
    ;; strategy, if you want to see the documentation from multiple providers.
    ;; (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
    ;; (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

    :config
    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  (use-package embark-consult
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** AI
*** Copilot
Copilot.el is an Emacs plugin for GitHub Copilot.

#+begin_src emacs-lisp
  (use-package copilot
    :straight (:host github :repo "zerolfx/copilot.el" :files ("dist" "*.el"))
    :hook
    ;; (prog-mode . (lambda ()
    ;;                (unless (string-match-p "*temp*" (buffer-name))
    ;;                  (copilot-mode))))
    (emacs-lisp-mode . (lambda ()
                         (setq-local copilot--indent-warning-printed-p t)))
    :config
    (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
    (define-key copilot-completion-map (kbd "C-<tab>") 'copilot-accept-completion-by-word)
    :general (ev/leader-key-map
              "a c m" 'copilot-mode
              "a c n" 'copilot-next-completion
              "a c p" 'copilot-previous-completion))
#+end_src

*** GPTel
GPTel allows us to talk with different LLMs from within Emacs.

#+begin_src emacs-lisp
  (use-package gptel
    :custom
    (gptel-default-mode #'org-mode)

    :config
    (with-eval-after-load 'gptel
      (evil-define-key 'normal gptel-mode-map "q" 'delete-window))

    (defun ev/next-prompt ()
      "Move the cursor to the next prompt"
      (interactive)
      (let ((empty-header-regexp "^\\*+\\s-*$"))
        (goto-char (point-max))
        (re-search-backward empty-header-regexp nil t))
      (move-end-of-line nil))

    (defun ev/gptel-get-default-key ()
      "Get the OpenAI API key from the auth-source"
      (interactive)
      (setq gptel-api-key (auth-source-pick-first-password
                           :host "OpenAI API Key"
                           :user "api key")))
    :general
    (ev/leader-key-map
     "a a" 'gptel
     "a g" 'gptel-menu)

    :hook
    ((gptel-mode . ev/gptel-get-default-key)
     (gptel-post-response . ev/next-prompt)))
#+end_src

** Popper
#+begin_src emacs-lisp
  (use-package popper
    :bind (("C-`"   . popper-toggle)
           ("M-`"   . popper-cycle)
           ("C-M-`" . popper-toggle-type))
    :init
    (setq popper-reference-buffers
          '("\\*Messages\\*"
            "Output\\*$"
            "\\*Async Shell Command\\*"
            help-mode
            compilation-mode))
    (popper-mode +1)
    (popper-echo-mode +1))                ; For echo area hints
#+end_src
