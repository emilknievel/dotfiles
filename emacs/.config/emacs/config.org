:DOC-CONFIG:
#+PROPERTY: header-args:emacs-lisp :tangle (concat (file-name-sans-extension (buffer-file-name)) ".el")
#+PROPERTY: header-args :mkdirp yes :comments no
#+STARTUP: overview
:END:

#+begin_src emacs-lisp :exports none
  ;;; config.el --- Configure emacs -*- lexical-binding:t -*-

  ;;; Commentary:

  ;; DO NOT EDIT THIS FILE DIRECTLY
  ;;
  ;; This is a file generated from a literate programming source file
  ;; located at `{{user-emacs-dir}}/config.org'
  ;;
  ;; You should make any changes there and regenerate it from Emacs
  ;; org-mode using C-c C-v t

  ;;; Code:
#+end_src

#+TITLE: Emacs Config
#+AUTHOR: Emil Vågstedt
#+EMAIL: emil.vagstedt@icloud.com
#+OPTIONS: toc:t

** Better defaults

Opinionated default [[https://git.sr.ht/~technomancy/better-defaults][settings]].

#+begin_src emacs-lisp
  (unless (or (fboundp 'helm-mode) (fboundp 'ivy-mode))
    (ido-mode t)
    (setopt ido-enable-flex-matching t))

  ;; (unless (memq window-system '(mac ns))
  ;;   (menu-bar-mode -1))
  (menu-bar-mode -1)
  (when (fboundp 'tool-bar-mode)
    (tool-bar-mode -1))
  (when (fboundp 'scroll-bar-mode)
    (scroll-bar-mode -1))
  (when (fboundp 'horizontal-scroll-bar-mode)
    (horizontal-scroll-bar-mode -1))

  (autoload 'zap-up-to-char "misc"
    "Kill up to, but not including ARGth occurrence of CHAR." t)

  (require 'uniquify)
  (setopt uniquify-buffer-name-style 'forward)

  ;; https://www.emacswiki.org/emacs/SavePlace
  (save-place-mode 1)

  (global-set-key (kbd "M-/") 'hippie-expand)
  (global-set-key (kbd "C-x C-b") 'ibuffer)
  (global-set-key (kbd "M-z") 'zap-up-to-char)

  (global-set-key (kbd "C-s") 'isearch-forward-regexp)
  (global-set-key (kbd "C-r") 'isearch-backward-regexp)
  (global-set-key (kbd "C-M-s") 'isearch-forward)
  (global-set-key (kbd "C-M-r") 'isearch-backward)

  (show-paren-mode 1)
  (setq-default indent-tabs-mode nil)
  (savehist-mode 1)

  (setq apropos-do-all t
        ediff-window-setup-function 'ediff-setup-windows-plain)

  (setopt save-interprogram-paste-before-kill t
          apropos-do-all t
          mouse-yank-at-point t
          require-final-newline t
          load-prefer-newer t
          backup-by-copying t
          frame-inhibit-implied-resize t
          custom-file (expand-file-name "custom.el" user-emacs-directory))

  (load custom-file 'noerror)

  ;; Revert buffers when the underlying file has changed
  (global-auto-revert-mode 1)

  ;; Revert Dired and other buffers
  (setopt global-auto-revert-non-file-buffers t)

  ;; Insert matching paren, bracket, etc. Surrounds active region with bracket.
  (electric-pair-mode 1)

  ;; Single space after a period is considered "end of sentence".
  (set-default 'sentence-end-double-space nil)

  ;; Turn off the bell by using the visual bell and setting it to `ignore'.
  (setopt visible-bell nil
          ring-bell-function 'ignore)
#+end_src

** Emacs system files

*** Backup files

#+begin_src emacs-lisp
  (unless backup-directory-alist
    (setopt backup-directory-alist `(("." . "/tmp/backups/"))))
#+end_src

*** Auto-save files

#+begin_src emacs-lisp
  (make-directory "/tmp/auto-saves/" t)

  (setopt auto-save-list-file-prefix "/tmp/auto-saves/sessions/"
          auto-save-file-name-transforms `((".*" ,"/tmp/auto-saves/" t)))

  (add-hook 'kill-emacs-hook (lambda ()
                               (dolist (file (directory-files
                                              temporary-file-directory
                                              t
                                              "\\`auto-save-file-name-p\\'"))
                                 (delete-file file))))
#+end_src

*** Lock files

#+begin_src emacs-lisp
  (setopt create-lockfiles nil)
#+end_src

** Calendar

Monday as first day of the week.

#+begin_src emacs-lisp
  (setopt calendar-week-start-day 1)
#+end_src

** Environment variables

*** Get OS shell variables

#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :ensure t
    :custom (exec-path-from-shell-variables '("PATH"
                                              "WSL_DISTRO_NAME"
                                              "XDG_CONFIG_HOME"
                                              "SSH_AUTH_SOCK"))
    :config (exec-path-from-shell-initialize)
    :when
    (or (memq window-system '(mac ns x pgtk)) (daemonp)))
#+end_src

*** Emacs specific

#+begin_src emacs-lisp
  (setenv "LANG" "en_US.UTF-8")
#+end_src

*** mise.el

#+begin_src emacs-lisp
  (use-package mise
    :ensure t
    :config
    (global-mise-mode))
#+end_src

** Security

*** TLS

Integrate Emacs with GnuTLS to ensure trusted connections.

#+begin_src emacs-lisp
  (use-package gnutls
    :defer t
    :custom
    (gnutls-verify-error nil))
#+end_src

*** Auth

#+begin_src emacs-lisp
  (defun my-get-auth-keyword (machine keyword)
    "Get KEYWORD value from auth-source for MACHINE.
  Example usage: \(get-auth-keyword \"test\" :secret)"
    (let ((result (auth-source-search :host machine :max 1)))
      (when result
        (let ((entry (car result)))
          (if (eq keyword :secret)
              (funcall (plist-get entry :secret))
            (plist-get entry keyword))))))
#+end_src

*** GPG

**** Loopback pinentry mode

Use minibuffer for passphrase queries instead of using an external Pinentry program.

#+begin_src emacs-lisp
  (setopt epg-pinentry-mode 'loopback)
#+end_src

** Utility

*** Functions

#+begin_src emacs-lisp
  (defun my-alist-keys (alist)
    "Return a list of all keys in ALIST."
    (mapcar #'car alist))
#+end_src

*** Time

**** Ensure consistent time locale

#+begin_src emacs-lisp
  (setq system-time-locale "C")
#+end_src

Mainly used for making sure that org timestamps are consistent.

** Key bindings

*** Evil (disabled)
:PROPERTIES:
:header-args:emacs-lisp: :tangle no
:END:

**** Base package

#+begin_src emacs-lisp
  (use-package evil
    :ensure t
    :hook (elpaca-log-mode . (lambda ()
                               (evil-local-set-key 'normal (kbd "gd")
                                                   'elpaca-log-view-diff)))
    :init
    ;; https://evil.readthedocs.io/en/latest/settings.html
    (setq evil-want-integration t
          evil-want-keybinding nil
          evil-toggle-key "C-z"
          evil-want-C-i-jump t
          evil-want-C-u-delete nil
          evil-want-C-u-scroll t ; default `nil'
          evil-want-C-d-scroll t
          evil-want-C-w-delete t
          evil-want-C-w-in-emacs-state nil
          evil-want-Y-yank-to-eol nil
          evil-disable-insert-state-bindings nil

          ;; Search
          evil-search-module 'isearch
          evil-regexp-search t
          evil-search-wrap t
          evil-flash-delay 2
          evil-ex-hl-update-delay 0.02
          evil-ex-search-incremental t

          ;; Indentation
          evil-auto-indent t
          evil-shift-width 4
          evil-shift-round t
          evil-indent-convert-tabs nil ; default `t'

          ;; Cursor movement
          evil-repeat-move-cursor t
          evil-move-cursor-back t
          evil-move-beyond-eol nil
          evil-v$-excludes-newline nil
          evil-cross-lines nil
          evil-respect-visual-line-mode t ; default `nil'
          evil-track-eol t
          evil-start-of-line nil

          ;; Cursor display
          evil-default-cursor t

          ;; Window management
          evil-auto-balance-windows t
          evil-split-window-below nil
          evil-vsplit-window-right nil

          ;; Parenthesis highlighting
          evil-show-paren-range 0
          evil-highlight-closing-paren-at-point-states '(not
                                                         emacs
                                                         insert
                                                         replace)

          ;; Miscellaneous
          evil-want-fine-undo nil
          evil-undo-system 'undo-redo ; default `nil'
          evil-backspace-join-lines t
          evil-kbd-macro-suppress-motion-error nil
          evil-mode-line-format 'before
          evil-mouse-word 'evil-word
          evil-transient-mouse-selection nil
          ;; evil-bigword default value used
          evil-esc-delay 0.01
          evil-intercept-esc 'always
          evil-kill-on-visual-paste t
          evil-echo-state t
          evil-complete-all-buffers t
          evil-want-empty-ex-last-command t
          )
    :config
    (evil-mode 1))
#+end_src

**** Evil surround

#+begin_src emacs-lisp
  (use-package evil-surround
    :ensure t
    :config
    (global-evil-surround-mode 1)
    (with-eval-after-load 'evil-surround
      (defun my-org-surround-pairs ()
        "Add Org markup pairs in org-mode buffers."
        (push '(?~ . ("~" . "~")) evil-surround-pairs-alist)
        (push '(?= . ("=" . "=")) evil-surround-pairs-alist)
        (push '(?* . ("*" . "*")) evil-surround-pairs-alist)
        (push '(?/ . ("/" . "/")) evil-surround-pairs-alist))
      (add-hook 'org-mode-hook #'my-org-surround-pairs)))
#+end_src

**** Evil collection

#+begin_src emacs-lisp
  (use-package evil-collection
    :ensure t
    :config (evil-collection-init))
#+end_src

**** Evil-commentary

#+begin_src emacs-lisp
  (use-package evil-commentary
    :ensure t
    :config
    (evil-commentary-mode))
#+end_src

**** Use "Emacs" initial state in terminal modes

#+begin_src emacs-lisp
  (with-eval-after-load 'evil
    (evil-set-initial-state 'eshell-mode 'emacs)
    (evil-set-initial-state 'term-mode 'emacs))
#+end_src

*** General.el

General provides a more convenient, unified interface for binding keys in Emacs. Check [[https://github.com/noctuid/general.el#reading-recommendations][this section]] in the repo for recommended reading before configuring with general.el.

**** Preamble

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      ;; Top level functions
      "C-," '(execute-extended-command :wk "M-x")

      ;; Prefixes

      "`" '(:ignore t :wk "Term")
      "a" '(:ignore t :wk "AI")
      "a c" '(:ignore t :wk "Copilot")
      "b" '(:ignore t :wk "Buffer")
      "c" '(:ignore t :wk "Code")
      "d" '(:ignore t :wk "Directory")
      "E" '(:ignore t :wk "Embark")
      "f" '(:ignore t :wk "File")
      "f c" '(:ignore t :wk "Config")
      "g" '(:ignore t :wk "Git")
      "h" '(:ignore t :wk "Help")
      "h d" '(:ignore t :wk "Devdocs")
      "n" '(:ignore t :wk "Notes")
      "o" '(:ignore t :wk "Org")
      "o b" '(:ignore t :wk "Babel")
      "p" '(:ignore t :wk "Project")
      "q" '(:ignore t :wk "Quit")
      "s" '(:ignore t :wk "Search")
      "t" '(:ignore t :wk "Toggle")
      "u" '(:ignore t :wk "UI")
      "u f" '(:ignore t :wk "Fonts")
      "u l" '(:ignore t :wk "Linum")
      "u m" '(:ignore t :wk "Mode Line")
      "w" '(:ignore t :wk "Windows")))

#+end_src

**** Files

#+begin_src emacs-lisp
  (defun my-reload-emacs-config ()
    "Tangle org file and reload the emacs config."
    (interactive)
    (org-babel-tangle-file (expand-file-name "config.org" user-emacs-directory))
    (load-file (expand-file-name "config.el" user-emacs-directory)))

  (defun my-edit-emacs-config ()
    "Edit Emacs literate config file."
    (interactive)
    (find-file (expand-file-name "config.org" user-emacs-directory)))

  (with-eval-after-load 'general
    (my-leader-keys
      "f c r" '(my-reload-emacs-config :wk "Reload config")
      "f c f" '(my-edit-emacs-config :wk "Edit config")
      "f f" 'find-file
      "f l" 'load-file
      "f s" 'save-buffer))
#+end_src

**** Buffers

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      ;; buffers
      "b" '(nil :wk "buffers")
      "b b" 'switch-to-buffer
      "b B" 'ibuffer
      "b c" 'consult-buffer
      "b X" 'scratch-buffer
      "q q" 'save-buffers-kill-terminal
      "b r" 'revert-buffer-quick))
#+end_src

**** Help

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      ;; help
      "h f" 'describe-function
      "h v" 'describe-variable
      "h k" 'describe-key
      "h i" 'info
      "h b" 'describe-bindings
      "h a" 'describe-face))
#+end_src

**** Toggles

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      ;; toggles
      "t v" '(visual-line-mode :wk "visual line mode")
      "t n" '(global-display-line-numbers-mode :wk "display line numbers")
      "t c" '(visual-fill-column-mode :wk "visual fill column mode")))
#+end_src

**** Emacs Client

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      ;; emacsclient
      "q k" '(save-buffers-kill-emacs :wk "Kill emacsclient process")))
#+end_src

*** Surround

#+begin_src emacs-lisp
  (use-package surround
    :ensure t
    :bind-keymap ("C-c s" . surround-keymap))
#+end_src

*** Meow (disabled)

#+begin_src emacs-lisp :tangle no
  (use-package meow
    :ensure t
    :init
    (defun meow-setup ()
      (setopt meow-replace-state-name-list '((normal . "<N>")
                                             (motion . "<M>")
                                             (keypad . "<K>")
                                             (insert . "<I>")
                                             (beacon . "<B>")))
      (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)

      (add-to-list 'meow-mode-state-list '(eshell-mode . insert))
      (add-to-list 'meow-mode-state-list '(eat-mode . insert))
      (add-to-list 'meow-mode-state-list '(term-mode . insert))
      (add-to-list 'meow-mode-state-list '(magit-mode . insert))

      (meow-motion-define-key
       '("j" . meow-next)
       '("k" . meow-prev)
       '("<escape>" . ignore))
      (meow-leader-define-key
       ;; Use SPC (0-9) for digit arguments.
       '("1" . meow-digit-argument)
       '("2" . meow-digit-argument)
       '("3" . meow-digit-argument)
       '("4" . meow-digit-argument)
       '("5" . meow-digit-argument)
       '("6" . meow-digit-argument)
       '("7" . meow-digit-argument)
       '("8" . meow-digit-argument)
       '("9" . meow-digit-argument)
       '("0" . meow-digit-argument)
       '("/" . meow-keypad-describe-key)
       '("?" . meow-cheatsheet))
      (meow-normal-define-key
       '("0" . meow-expand-0)
       '("9" . meow-expand-9)
       '("8" . meow-expand-8)
       '("7" . meow-expand-7)
       '("6" . meow-expand-6)
       '("5" . meow-expand-5)
       '("4" . meow-expand-4)
       '("3" . meow-expand-3)
       '("2" . meow-expand-2)
       '("1" . meow-expand-1)
       '("-" . negative-argument)
       '(";" . meow-reverse)
       '("," . meow-inner-of-thing)
       '("." . meow-bounds-of-thing)
       '("[" . meow-beginning-of-thing)
       '("]" . meow-end-of-thing)
       '("a" . meow-append)
       '("A" . meow-open-below)
       '("b" . meow-back-word)
       '("B" . meow-back-symbol)
       '("c" . meow-change)
       '("d" . meow-delete)
       '("D" . meow-backward-delete)
       '("e" . meow-next-word)
       '("E" . meow-next-symbol)
       '("f" . meow-find)
       '("g" . meow-cancel-selection)
       '("G" . meow-grab)
       '("h" . meow-left)
       '("H" . meow-left-expand)
       '("i" . meow-insert)
       '("I" . meow-open-above)
       '("j" . meow-next)
       '("J" . meow-next-expand)
       '("k" . meow-prev)
       '("K" . meow-prev-expand)
       '("l" . meow-right)
       '("L" . meow-right-expand)
       '("m" . meow-join)
       '("n" . meow-search)
       '("o" . meow-block)
       '("O" . meow-to-block)
       '("p" . meow-yank)
       '("q" . meow-quit)
       '("Q" . meow-goto-line)
       '("r" . meow-replace)
       '("R" . meow-swap-grab)
       '("s" . meow-kill)
       '("t" . meow-till)
       '("u" . meow-undo)
       '("U" . meow-undo-in-selection)
       '("v" . meow-visit)
       '("w" . meow-mark-word)
       '("W" . meow-mark-symbol)
       '("x" . meow-line)
       '("X" . meow-goto-line)
       '("y" . meow-save)
       '("Y" . meow-sync-grab)
       '("z" . meow-pop-selection)
       '("'" . repeat)
       '("<escape>" . ignore)))
    :config
    (meow-setup)
    (meow-setup-indicator)
    (meow-global-mode 1))
#+end_src

*** Repeat mode

Repeat commands by typing a single character.

#+begin_src emacs-lisp
  (repeat-mode 1)
#+end_src

*** Which-key

#+begin_src emacs-lisp
  (use-package which-key
    :ensure nil
    :init
    (which-key-mode)
    (which-key-setup-side-window-bottom)
    :custom
    (which-key-idle-delay 0.3))
#+end_src

** Editing

*** iedit

Edit multiple occurrences in the same way simultaneously.

#+begin_src emacs-lisp
  (use-package iedit
    :ensure t
    :general
    (my-leader-keys "e" 'iedit-mode))
#+end_src

*** Whitespace

**** Show trailing whitespace

#+begin_src emacs-lisp
  (require 'whitespace)
  (setq-default show-trailing-whitespace nil)

  (dolist (hook '(prog-mode-hook
                  conf-mode-hook
                  org-mode-hook
                  markdown-mode-hook
                  tex-mode-hook))
    (add-hook hook (lambda ()
                     (setq show-trailing-whitespace t))))
#+end_src

**** Interactive toggle for trailing whitespace highlight

#+begin_src emacs-lisp
  (defun my-toggle-show-trailing-whitespace ()
    "Toggle whether or not to show trailing whitespace in buffer."
    (interactive)
    (if (eq show-trailing-whitespace nil)
        (setq show-trailing-whitespace t)
      (setq show-trailing-whitespace nil)))

  (with-eval-after-load 'general
    (my-leader-keys
      "t w" 'my-toggle-show-trailing-whitespace))
#+end_src

*** Expand region

Increase selected region by /semantic units/.

#+begin_src emacs-lisp
  (use-package expand-region
    :ensure t
    :after general
    :general (my-leader-keys "=" 'er/expand-region))
#+end_src

*** Vundo

Visual undo. Displays the undo history as a tree and lets you move in the tree to go back to previous buffer states.

Invoked with ~M-x vundo~ or ~<leader> c u~.

#+begin_src emacs-lisp
  (use-package vundo
    :ensure t
    :after general
    :general (my-leader-keys "c u" 'vundo))
#+end_src

*** Multiple cursors

#+begin_src emacs-lisp
  (use-package multiple-cursors
    :ensure t
    :config
    (defhydra hydra-multiple-cursors (global-map "C-c")
      "multiple cursors"
      ("M-d" mc/mark-next-like-this "mark next")
      ("M-D" mc/unmark-previous-like-this "mark previous")))
#+end_src

*** Delete selected text upon insertion

#+begin_src emacs-lisp
  (use-package delsel
    :ensure nil ; no need to install it as it is built-in
    :hook (after-init . delete-selection-mode))
#+end_src

*** Wrap lines exceeding window size where appropriate

#+begin_src emacs-lisp
  (add-hook 'magit-diff-mode-hook 'visual-line-mode)
  (add-hook 'org-mode-hook 'visual-line-mode)
  (add-hook 'markdown-mode-hook 'visual-line-mode)
#+end_src

*** Highlight line

#+begin_src emacs-lisp
  ;; (add-hook 'org-agenda-mode-hook 'hl-line-mode)

  (defun my-toggle-global-hl-line-mode ()
    "Toggle `global-hl-line-mode'."
    (interactive)
    (global-hl-line-mode 'toggle))

  (with-eval-after-load 'general
    (my-leader-keys
      "t h" 'my-toggle-global-hl-line-mode))
#+end_src

*** Deindent text saved to kill-ring

#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook 'kill-ring-deindent-mode)
  (add-hook 'conf-mode-hook 'kill-ring-deindent-mode)
#+end_src

*** Text Folding

**** Kirigami.el

#+begin_src emacs-lisp
  (use-package kirigami
    :ensure (:host github :repo "jamescherti/kirigami.el")
    :after evil
    :config
    (define-key evil-normal-state-map "zo" 'kirigami-open-fold)
    (define-key evil-normal-state-map "zO" 'kirigami-open-fold-rec)
    (define-key evil-normal-state-map "zc" 'kirigami-close-fold)
    (define-key evil-normal-state-map "za" 'kirigami-toggle-fold)
    (define-key evil-normal-state-map "zr" 'kirigami-open-folds)
    (define-key evil-normal-state-map "zm" 'kirigami-close-folds))
#+end_src

** Eldoc

#+begin_src emacs-lisp
  (use-package eldoc
    :ensure nil
    :config
    (setq-default eldoc-idle-delay 0.2
                  ;; eldoc-echo-area-use-multiline-p t
                  eldoc-echo-area-prefer-doc-buffer t
                  eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly))
#+end_src

** Customization

*** Get rid of the annoying startup screen

#+begin_src emacs-lisp
  (setopt inhibit-startup-screen t)
#+end_src

*** Confirm exit with y/n instead of yes/no

#+begin_src emacs-lisp
  (setopt confirm-kill-emacs 'y-or-n-p)
#+end_src

*** Scrolling

**** Defaults

#+begin_src emacs-lisp
  (setopt scroll-conservatively 3
          scroll-margin 0)
#+end_src

**** Smooth scrolling

#+begin_src emacs-lisp
  ;; (pixel-scroll-precision-mode)

  (use-package ultra-scroll
    :ensure t
    :config
    (ultra-scroll-mode 1))
#+end_src

*** macOS

#+begin_src emacs-lisp
  (when (eq system-type 'darwin)
    (use-package ns-auto-titlebar
      :ensure t
      :demand t
      :config (ns-auto-titlebar-mode))
    (setq-default ns-use-proxy-icon nil
                  ns-use-mwheel-momentum t
                  ns-use-mwheel-acceleration t
                  ns-use-thin-smoothing t
                  ;; ns-antialias-text nil
                  mac-command-modifier 'meta
                  mac-right-command-modifier 'meta
                  mac-option-modifier 'none
                  mac-control-modifier 'control
                  frame-title-format ""))
#+end_src

*** WSL

Workaround for copying text from Emacs to the Windows clipboard:
#+begin_src emacs-lisp
  (when (getenv "WSL_DISTRO_NAME")
    (defun copy-selected-text (start end)
      (interactive "r")
      (if (use-region-p)
          (let ((text (buffer-substring-no-properties start end)))
            (shell-command (concat "echo '" text "' | clip.exe"))))))
#+end_src

*** Themes

**** Themes directory

#+begin_src emacs-lisp
  (setopt custom-theme-directory "~/.config/emacs/themes/")
#+end_src

**** Functions

#+begin_src emacs-lisp
  (defun my-clear-theme ()
    "Clear current theme"
    (interactive)
    (mapc #'disable-theme custom-enabled-themes))

  (defun my-load-theme (&optional theme)
    "Load THEME after clearing the previous one.
  If called interactively, prompt for a theme name. If THEME is provided
  as an argument, load that theme directly."
    (interactive)
    (my-clear-theme)
    (if theme
        (load-theme theme t)
      (call-interactively 'load-theme)))

  ;; (setq my-catppuccin-flavors (my-alist-keys catppuccin-flavor-alist))

  ;; (defun my-catppuccin-theme (flavor)
  ;;   "Clear previous theme and load selected catppuccin FLAVOR."
  ;;   (interactive
  ;;    (list (intern (completing-read "Choose a flavor: "
  ;;                                   my-catppuccin-flavors))))
  ;;   (my-clear-theme)
  ;;   (catppuccin-load-flavor flavor))

  (defun my-load-theme-in-all-frames (frame)
    "Load the current theme in the newly created FRAME.
  When loaded after a new frame has been created with emacsclient, it
  ensures that the theme is properly applied. In particular this solves a
  problem with the menu bar not using the proper theme if the server was
  loaded with a different theme."
    (with-selected-frame frame
      (enable-theme (car custom-enabled-themes))
      (when (string-prefix-p "ef-" (symbol-name
                                    (car custom-enabled-themes)))
        (modus-themes-load-theme (car custom-enabled-themes)))
      (when (string-prefix-p "standard-" (symbol-name
                                          (car custom-enabled-themes)))
        (modus-themes-load-theme (car custom-enabled-themes)))
      (when (string-prefix-p "modus-" (symbol-name
                                       (car custom-enabled-themes)))
        (modus-themes-load-theme (car custom-enabled-themes)))))
#+end_src

**** Hooks

#+begin_src emacs-lisp
  (add-hook 'after-make-frame-functions #'my-load-theme-in-all-frames)
#+end_src

**** Modus themes

#+begin_src emacs-lisp
  (use-package modus-themes
    :ensure t
    :init
    (setopt modus-themes-mixed-fonts nil
            modus-themes-variable-pitch-ui nil
            modus-themes-to-toggle '(modus-operandi modus-vivendi)
            modus-themes-common-palette-overrides '((fringe unspecified)))
            ;; modus-themes-headings '((0 . (1.5))
            ;;                         (1 . (1.4))
            ;;                         (2 . (1.3))
            ;;                         (3 . (1.2))
            ;;                         (4 . (1.1))
            ;;                         (5 . (1.1))
            ;;                         (6 . (1.0))
            ;;                         (7 . (1.0))))
    (modus-themes-include-derivatives-mode 1)
    (my-load-theme 'modus-vivendi)
    :general (my-leader-keys
               "t t m" 'modus-themes-toggle))
#+end_src

**** Ef themes

#+begin_src emacs-lisp
  (use-package ef-themes :ensure t)
#+end_src

**** Standard themes

#+begin_src emacs-lisp
  (use-package standard-themes :ensure t)
#+end_src

**** Catppuccin

#+begin_src emacs-lisp
  (use-package catppuccin-theme
    :ensure t
    :init
    (setq catppuccin-flavor 'mocha)
    ;; (defun my-load-catppuccin-latte ()
    ;;   (interactive)
    ;;   (when (not (eq catppuccin-flavor 'latte)) (setq catppuccin-flavor 'latte))
    ;;   (my-load-theme 'catppuccin))

    ;; (defun my-load-catppuccin-mocha ()
    ;;   (interactive)
    ;;   (when (not (eq catppuccin-flavor 'mocha)) (setq catppuccin-flavor 'mocha))
    ;;   (my-load-theme 'catppuccin))

    ;; (defun my-catppuccin-toggle ()
    ;;   (interactive)
    ;;   (if (not (eq catppuccin-flavor 'mocha))
    ;;       (my-load-catppuccin-mocha)
    ;;     (my-load-catppuccin-latte)))

    (defun my-catppuccin-toggle ()
      (interactive)
      (my-load-theme 'catppuccin))
    :general (my-leader-keys "t t c" 'my-catppuccin-toggle))

  ;; (use-package modus-catppuccin
  ;;   :ensure (:host "www.gitlab.com"
  ;;                  :repo "magus/modus-catppuccin"
  ;;                  :branch "main"
  ;;                  :main "modus-catppuccin.el")
  ;;   :demand t
  ;;   :init
  ;;   (defun my-catppuccin-mocha ()
  ;;     (interactive)
  ;;     (modus-themes-load-theme 'catppuccin-mocha))
  ;;   (setopt catppuccin-mocha-palette-overrides '((cursor rosewater)
  ;;                                                (org-code mauve)))
  ;;   :general (my-leader-keys "t t c" 'my-catppuccin-mocha))
#+end_src

**** Doric themes

#+begin_src emacs-lisp
  (use-package doric-themes
    :ensure t
    :general
    (my-leader-keys "t t o" 'doric-themes-toggle)
    :custom
    (doric-themes-to-toggle '(doric-marble doric-obsidian)))
#+end_src

**** Doom

#+begin_src emacs-lisp
  (use-package doom-themes
    :ensure t
    :after general
    :init
    (defun my-doom-one ()
      "Clear previous theme and load doom-one."
      (interactive)
      (my-load-theme 'doom-one))

    (defun my-gruvbox ()
      "Clear previous theme and load gruvbox."
      (interactive)
      (my-load-theme 'doom-gruvbox))

    (defun my-gruvbox-light ()
      "Clear previous theme and load gruvbox."
      (interactive)
      (my-load-theme 'doom-gruvbox-light))

    (defun my-toggle-gruvbox ()
      "Toggle between light and dark Gruvbox themes."
      (interactive)
      (if (eq (nth 0 custom-enabled-themes) 'doom-gruvbox)
          (my-gruvbox-light)
        (my-gruvbox)))

    (defun my-toggle-tomorrow ()
      "Toggle between light and dark Tomorrow themes."
      (interactive)
      (if (eq (nth 0 custom-enabled-themes) 'doom-tomorrow-night)
          (my-load-theme 'doom-tomorrow-day)
        (my-load-theme 'doom-tomorrow-night)))

    (defun my-zenburn ()
      "Clear previous theme and load zenburn."
      (interactive)
      (my-load-theme 'doom-zenburn))
    :custom
    (doom-themes-enable-bold nil)
    (doom-themes-enable-italic nil)
    :config
    (doom-themes-org-config)
    :general (my-leader-keys
               "t t d" 'my-doom-one
               "t t g" 'my-toggle-gruvbox
               "t t z" 'my-zenburn))
#+end_src

**** Naysayer

Based on theme from Jonathan Blow's livestreams.

#+begin_src emacs-lisp
  (use-package naysayer-theme
    :ensure t
    :after general
    :init
    (defun my-naysayer-theme ()
      "Clear previous theme and load naysayer."
      (interactive)
      (my-load-theme 'naysayer))
    :general (my-leader-keys "t t n" 'my-naysayer-theme))
#+end_src

**** Acme theme

Inspired by Plan 9 Acme & Sam.

#+begin_src emacs-lisp
  (use-package acme-theme
    :ensure t
    :after general
    :init
    (setq acme-theme-black-fg t)

    (defun my-acme-theme ()
      "Clear previous theme and load acme."
      (interactive)
      (my-load-theme 'acme))
    :general (my-leader-keys "t t a" 'my-acme-theme))
#+end_src

**** Kaolin

#+begin_src emacs-lisp
  (use-package kaolin-themes
    :ensure t
    :init
    (defun my-kaolin-dark ()
      "Clear previous theme and load kaolin dark."
      (interactive)
      (my-load-theme 'kaolin-dark))

    (defun my-kaolin-light ()
      "Clear previous theme and load kaolin light."
      (interactive)
      (my-load-theme 'kaolin-light))

    (defun my-kaolin-mono-dark ()
      "Clear previous theme and load kaolin mono dark."
      (interactive)
      (my-load-theme 'kaolin-mono-dark))

    (defun my-kaolin-mono-light ()
      "Clear previous theme and load kaolin mono light."
      (interactive)
      (my-load-theme 'kaolin-mono-light))

    :general (my-leader-keys "t t k" 'my-kaolin-dark))
#+end_src

**** Solarized

#+begin_src emacs-lisp
  (with-eval-after-load 'general
    (my-leader-keys
      "t t s" 'my-toggle-solarized))

  (defun my-toggle-solarized ()
    "Toggle between light and dark solarized themes."
    (interactive)
    (if (eq (nth 0 custom-enabled-themes) 'doom-solarized-dark)
        (my-solarized-light)
      (my-solarized-dark)))

  (defun my-solarized-light ()
    "Clear previous theme and load solarized light"
    (interactive)
    (my-load-theme 'doom-solarized-light))

  (defun my-solarized-dark ()
    "Clear previous theme and load solarized dark"
    (interactive)
    (my-load-theme 'doom-solarized-dark))
#+end_src

**** Auto-Dark for Emacs

#+begin_src emacs-lisp
  (use-package auto-dark
    :ensure t
    :if (eq system-type 'darwin)
    :init
    (defconst my-dark-theme 'modus-vivendi)
    (defconst my-light-theme 'modus-operandi)

    (setopt auto-dark-allow-osascript t
            auto-dark-themes `((,my-dark-theme) (,my-light-theme))
            custom-safe-themes t)

    (auto-dark-mode 1)

    (defun my-toggle-auto-theme ()
      (interactive)
      (if (eq (nth 0 custom-enabled-themes) my-dark-theme)
          (my-load-theme my-light-theme)
        (my-load-theme my-dark-theme)))
    :hook
    (auto-dark-dark-mode . (lambda ()
                               (my-load-theme my-dark-theme)))
    (auto-dark-light-mode . (lambda ()
                                (my-load-theme my-light-theme)))

    :general (my-leader-keys "t t t" 'my-toggle-auto-theme))
#+end_src

*** Fonts

**** Font variables

#+begin_src emacs-lisp
  (defvar my-linux-font "hack")
  (defvar my-macos-font "sf mono")

  (if (eq system-type 'darwin)
      (defvar my-editor-font my-macos-font)
    (defvar my-editor-font my-linux-font))

  (if (eq system-type 'darwin)
      (progn (defvar my-default-font my-editor-font)
             (defvar my-variable-pitch-font "sf pro")
             (defvar my-serif-font "georgia"))
    (progn (defvar my-default-font my-editor-font)
           (defvar my-variable-pitch-font "noto sans")
           (defvar my-serif-font "noto serif")))
#+end_src

**** Setup editor fonts

#+begin_src emacs-lisp
  (defvar my-active-font-narrow-p
    (string-match-p "aporetic\\|iosevka\\|mononoki\\|zed"
                    (downcase my-editor-font))
    "`t' if font is narrow, i.e. appears smaller.")

  (defvar my-font-offset (if my-active-font-narrow-p 10 0)
    "Font size offset.")

  (defun my-setup-linux-fonts ()
    "Separate setups for fonts in WSL and regular GNU/Linux."
    (if (getenv "WSL_DISTRO_NAME")
        (setq my-font-height (+ 110 my-font-offset)
              my-small-font-height (+ 90 my-font-offset)
              my-medium-font-height (+ 120 my-font-offset)
              my-large-font-height (+ 130 my-font-offset)
              my-presentation-font-height (+ 150 my-font-offset))
      (setq my-font-height (+ 100 my-font-offset)
            my-small-font-height (+ 90 my-font-offset)
            my-medium-font-height (+ 110 my-font-offset)
            my-large-font-height (+ 130 my-font-offset)
            my-presentation-font-height (+ 140 my-font-offset))))

  (if (eq system-type 'darwin)
      (setq my-font-height (+ 120 my-font-offset)
            my-small-font-height (+ 110 my-font-offset)
            my-medium-font-height (+ 130 my-font-offset)
            my-large-font-height (+ 160 my-font-offset)
            my-presentation-font-height (+ 200 my-font-offset))
    (my-setup-linux-fonts))

  (set-face-attribute 'default nil
                      :family my-default-font
                      :height my-font-height)
  ;; (set-face-attribute 'fixed-pitch nil
  ;;                     :family my-editor-font
  ;;                     :height 1.0)
  ;; (set-face-attribute 'variable-pitch nil
  ;;                     :family my-variable-pitch-font
  ;;                     :height 1.0)
  ;; (set-face-attribute 'italic nil :slant 'italic :underline nil)

  ;; (defun my-reading-mode ()
  ;;   (interactive)
  ;;   (set-face-attribute 'variable-pitch nil
  ;;                       :family my-serif-font))
  ;; (defun my-quit-reading-mode ()
  ;;   (interactive)
  ;;   (set-face-attribute 'variable-pitch nil
  ;;                       :family my-variable-pitch-font))
#+end_src

**** Variable pitch

#+begin_src emacs-lisp
  ;; Persistent flag for mixed-pitch mode
  (defcustom my-enable-mixed-pitch t
    "Enable mixed-pitch mode in org and markdown buffers."
    :type 'boolean
    :group 'editing
    :set (lambda (symbol value)
           (set-default symbol value)
           ;; Apply to existing buffers when changed
           (dolist (buffer (buffer-list))
             (with-current-buffer buffer
               (when (or (derived-mode-p 'org-mode)
                         (derived-mode-p 'markdown-mode))
                 (if value
                     (mixed-pitch-mode 1)
                   (mixed-pitch-mode -1)))))))

  ;; Function to conditionally enable mixed-pitch
  (defun my-maybe-enable-mixed-pitch ()
    "Enable mixed-pitch-mode if enabled."
    (when my-enable-mixed-pitch
      (mixed-pitch-mode 1)))

  ;; Toggle function for convenience
  (defun my-toggle-mixed-pitch ()
    "Toggle mixed-pitch mode setting."
    (interactive)
    (customize-set-variable 'my-enable-mixed-pitch (not my-enable-mixed-pitch))
    (customize-save-variable 'my-enable-mixed-pitch my-enable-mixed-pitch)
    (message "Mixed-pitch %s" (if my-enable-mixed-pitch "enabled" "disabled")))

  (use-package mixed-pitch
    :ensure t
    :bind ("<f9>" . my-toggle-mixed-pitch)
    :hook ((org-mode markdown-mode) . my-maybe-enable-mixed-pitch)
    :custom (mixed-pitch-variable-pitch-cursor nil))
#+end_src

**** Ligatures

Display ligatures. Disabled by default. Enable with ~<leader> u f l~ =(ui->fonts->ligatures)=.

#+begin_src emacs-lisp
  (use-package ligature
    :ensure t
    :after general
    :config
    (ligature-set-ligatures
     'prog-mode
     '("--" "---" "==" "===" "!=" "!==" "=!="
       "=:=" "=/=" "<=" ">=" "&&" "&&&" "&=" "++" "+++" "***" ";;" "!!"
       "??" "???" "?:" "?." "?=" "<:" ":<" ":>" ">:" "<:<" "<>" "<<<" ">>>"
       "<<" ">>" "||" "-|" "_|_" "|-" "||-" "|=" "||=" "##" "###" "####"
       "#{" "#[" "]#" "#(" "#?" "#_" "#_(" "#:" "#!" "#=" "^=" "<$>" "<$"
       "$>" "<+>" "<+" "+>" "<*>" "<*" "*>" "</" "</>" "/>" "<!--" "<#--"
       "-->" "->" "->>" "<<-" "<-" "<=<" "=<<" "<<=" "<==" "<=>" "<==>"
       "==>" "=>" "=>>" ">=>" ">>=" ">>-" ">-" "-<" "-<<" ">->" "<-<" "<-|"
       "<=|" "|=>" "|->" "<->" "<~~" "<~" "<~>" "~~" "~~>" "~>" "~-" "-~"
       "~@" "[||]" "|]" "[|" "|}" "{|" "[<" ">]" "|>" "<|" "||>" "<||"
       "|||>" "<|||" "<|>" "..." ".." ".=" "..<" ".?" "::" ":::" ":=" "::="
       ":?" ":?>" "//" "///" "/*" "*/" "/=" "//=" "/==" "@_" "__" "???"
       "<:<" ";;;"))
    :general
    (my-leader-keys
      "u f l" 'global-ligature-mode))
#+end_src

**** Show Font

Preview fonts in Emacs.

#+begin_src emacs-lisp
  (use-package show-font :ensure t)
#+end_src

**** Fontaine

#+begin_src emacs-lisp
  (use-package fontaine
    :ensure t
    :demand t
    :general (my-leader-keys "u f p" 'fontaine-set-preset)
    :bind ("<f7>" . fontaine-set-preset)
    :config
    (setq fontaine-latest-state-file
          (locate-user-emacs-file "fontaine-latest-state.eld"))

    (setq fontaine-presets
          `((small :default-height ,my-small-font-height)
            (regular) ; like this it uses all the fallback values and is named
                      ; `regular'
            (medium :default-height ,my-medium-font-height)
            (large :default-height ,my-large-font-height)
            (presentation :default-height ,my-presentation-font-height)
            (t
             ;; I keep all properties for didactic purposes, but most can be
             ;; omitted.
             ;; See the fontaine manual for the technicalities:
             ;; <https://protesilaos.com/emacs/fontaine>.
             :default-family ,my-default-font
             :default-weight regular
             :default-height ,my-font-height

             :fixed-pitch-family ,my-default-font ; falls back to :default-family
             :fixed-pitch-weight nil ; falls back to :default-weight
             :fixed-pitch-height 1.0 ;,(/ 1 1.1)

             :fixed-pitch-serif-family nil ; falls back to :default-family
             :fixed-pitch-serif-weight nil ; falls back to :default-weight
             :fixed-pitch-serif-height 1.0

             :variable-pitch-family ,my-variable-pitch-font
             :variable-pitch-weight nil
             :variable-pitch-height 1.0 ; 1.1

             :mode-line-active-family nil ; falls back to :default-family
             :mode-line-active-weight nil ; falls back to :default-weight
             :mode-line-active-height 1.0

             :mode-line-inactive-family nil ; falls back to :default-family
             :mode-line-inactive-weight nil ; falls back to :default-weight
             :mode-line-inactive-height 1.0

             :header-line-family nil ; falls back to :default-family
             :header-line-weight nil ; falls back to :default-weight
             :header-line-height 1.0

             :line-number-family nil ; falls back to :default-family
             :line-number-weight nil ; falls back to :default-weight
             :line-number-height 1.0

             :tab-bar-family nil ; falls back to :default-family
             :tab-bar-weight nil ; falls back to :default-weight
             :tab-bar-height 1.0

             :tab-line-family nil ; falls back to :default-family
             :tab-line-weight nil ; falls back to :default-weight
             :tab-line-height 1.0

             :bold-family nil ; use whatever the underlying face has
             :bold-weight nil

             :italic-family nil
             :italic-slant nil

             :line-spacing nil)))

    ;; Set the last preset or fall back to desired style from `fontaine-presets'
    ;; (the `regular' in this case).
    (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))

    ;; Persist the latest font preset when closing/starting Emacs and while
    ;; switching between themes.
    (fontaine-mode 1))
#+end_src

**** Line spacing (disabled)

Increase line spacing slightly in buffers containing prose.

#+begin_src emacs-lisp :tangle no
  (dolist (hook '(
                  org-mode-hook
                  org-agenda-mode-hook
                  markdown-mode-hook
                  eww-mode-hook
                  devdocs-mode-hook
                  Info-mode-hook
                  ))
    (add-hook hook (lambda ()
                     (setq-local line-spacing .25))))
#+end_src

*** Display line numbers

Turn on line numbers for program and configuration modes.

#+begin_src emacs-lisp
  (use-package display-line-numbers
    :ensure nil
    :after general
    :config
    (defun my-display-line-numbers-absolute ()
      "Setup for absolute line numbers."
      (interactive)
      (setopt display-line-numbers-type t)
      (global-display-line-numbers-mode 1))

    (defun my-display-line-numbers-relative ()
      "Setup for relative line numbers."
      (interactive)
      (setopt display-line-numbers-type 'relative)
      (global-display-line-numbers-mode 1))

    (defun my-display-line-numbers-visual ()
      "Setup for relative line numbers."
      (interactive)
      (setopt display-line-numbers-type 'visual)
      (global-display-line-numbers-mode 1))

    (defun my-display-line-numbers-hidden ()
      "Hide line numbers."
      (interactive)
      (global-display-line-numbers-mode -1))
    :custom
    (display-line-numbers-width 3)
    (display-line-numbers-widen nil)
    (display-line-numbers-grow-only nil)
    :general
    (my-leader-keys
      "u l a" '(my-display-line-numbers-absolute :wk "Line Numbers: Absolute")
      "u l r" '(my-display-line-numbers-relative :wk "Line Numbers: Relative")
      "u l v" '(my-display-line-numbers-visual :wk "Line Numbers: Visual")
      "u l h" '(my-display-line-numbers-hidden :wk "Line Numbers: Hidden")))
#+end_src

*** Icons

**** Nerd icons

Install the icons with ~M-x nerd-icons-install-fonts~.

#+begin_src emacs-lisp
  (use-package nerd-icons :ensure t)
#+end_src

***** Nerd icons for dired

#+begin_src emacs-lisp
  (use-package nerd-icons-dired
    :ensure t
    :hook ((dired-mode . nerd-icons-dired-mode)
           ;; prevent icons from overlapping vertically
           (dired-mode . (lambda () (setq-local line-spacing 0.25)))))
#+end_src

*** Mode line

**** Display cursor column

#+begin_src emacs-lisp
  (column-number-mode 1)
#+end_src

**** Inherit active face from base

This ensures that =mode-line-active= face inherits =mode-line=.

#+begin_src emacs-lisp
  (set-face-attribute 'mode-line-active nil :inherit 'mode-line)
#+end_src

**** Display current date and time on the mode line

Display the current date and time on the mode line.

#+begin_src emacs-lisp
  (setopt display-time-format " %H:%M "
          display-time-interval 60
          display-time-default-load-average nil)

  ;; Only display current date and time, not email stuff
  (setopt display-time-string-forms
          '((propertize (format-time-string display-time-format now)
                        ;; 'face 'display-time-date-and-time
                        'help-echo (format-time-string "%a %b %e, %Y" now))
            " "))

  (display-time-mode 1)
#+end_src

**** Minions

=minions.el= by Jonas Bernoulli implements a nested menu that gives access to all known minor modes.

#+begin_src emacs-lisp
  (use-package minions
    :ensure t
    :after general
    :init
    (minions-mode))
#+end_src

*** Padding (disabled)

#+begin_src emacs-lisp :tangle no
  (use-package spacious-padding
    :ensure t
    :config
    (setq spacious-padding-widths
     '( :internal-border-width 15
        :header-line-width 4
        :mode-line-width 6
        :tab-width 4
        :right-divider-width 30
        :scroll-bar-width 8
        :fringe-width 8))
    (setq spacious-padding-subtle-frame-lines t)
    :config
    (spacious-padding-mode 1))
#+end_src

** Completion

*** Nerd Icons Completion

#+begin_src emacs-lisp
  (use-package nerd-icons-completion
    :ensure t
    :after (marginalia nerd-icons)
    :hook (marginalia-mode . nerd-icons-completion-marginalia-setup)
    :init
    (nerd-icons-completion-mode))
#+end_src

*** Marginalia

#+begin_src emacs-lisp
  (use-package marginalia
    :ensure t
    :after (vertico general)
    :general
    (:keymaps 'minibuffer-local-map
              "M-a" 'marginalia-cycle)
    :custom
    (marginalia-max-relative-age 0)
    (marginalia-align 'right)
    (marginalia-annotators '(marginalia-annotators-heavy
                             marginalia-annotators-light
                             nil))
    :init
    (marginalia-mode))
#+end_src

*** Vertico

#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :demand t ; Otherwise won't get loaded immediately
    :after general
    :general
    (:keymaps 'global
              "C-<" #'vertico-repeat ; C-S-,
              )
    (:keymaps 'vertico-map
              "<tab>" #'vertico-insert ; Set manually otherwise setting
                                       ; `vertico-quick-insert' overrides this
              "<escape>" #'minibuffer-keyboard-quit
              "?" #'minibuffer-completion-help
              "C-M-n" #'vertico-next-group
              "C-M-p" #'vertico-previous-group
              ;; Multiform toggles
              "<backspace>" #'vertico-directory-delete-char
              "C-w" #'vertico-directory-delete-word
              "C-<backspace>" #'vertico-directory-delete-word
              "RET" #'vertico-directory-enter
              "C-i" #'vertico-quick-insert
              "C-o" #'vertico-quick-exit
              "M-o" #'kb/vertico-quick-embark
              "M-G" #'vertico-multiform-grid
              "M-F" #'vertico-multiform-flat
              "M-R" #'vertico-multiform-reverse
              "M-U" #'vertico-multiform-unobtrusive
              "C-l" #'kb/vertico-multiform-flat-toggle
              )
    :hook
    (
     ;; Clean up file when typing
     (rfn-eshadow-update-overlay . vertico-directory-tidy)
     ;; Make sure vertico state is saved
     (minibuffer-setup . vertico-repeat-save)
     )
    :custom
    (vertico-count 13)
    (vertico-resize t)
    (vertico-cycle nil)
    ;; Extensions
    (vertico-grid-separator "       ")
    (vertico-grid-lookahead 50)
    (vertico-buffer-display-action '(display-buffer-reuse-window))
    (vertico-multiform-categories
     '((file reverse)
       (consult-grep buffer)
       (consult-location)
       (imenu buffer)
       (library reverse indexed)
       (org-roam-node reverse indexed)
       (t reverse)
       ))
    (vertico-multiform-commands
     '(("flyspell-correct-*" grid reverse)
       (org-refile grid reverse indexed)
       (consult-yank-pop indexed)
       (consult-flycheck)
       (consult-lsp-diagnostics)
       ))
    :init
    (defun kb/vertico-multiform-flat-toggle ()
      "Toggle between flat and reverse."
      (interactive)
      (vertico-multiform--display-toggle 'vertico-flat-mode)
      (if vertico-flat-mode
          (vertico-multiform--temporary-mode 'vertico-reverse-mode -1)
        (vertico-multiform--temporary-mode 'vertico-reverse-mode 1)))
    (defun kb/vertico-quick-embark (&optional arg)
      "Embark on candidate using quick keys."
      (interactive)
      (when (vertico-quick-jump)
        (embark-act arg)))

    ;; Workaround for problem with `tramp' hostname completions. This overrides
    ;; the completion style specifically for remote files! See
    ;; https://github.com/minad/vertico#tramp-hostname-completion
    (defun kb/basic-remote-try-completion (string table pred point)
      (and (vertico--remote-p string)
           (completion-basic-try-completion string table pred point)))
    (defun kb/basic-remote-all-completions (string table pred point)
      (and (vertico--remote-p string)
           (completion-basic-all-completions string table pred point)))
    (add-to-list 'completion-styles-alist
                 '(basic-remote           ; Name of `completion-style'
                   kb/basic-remote-try-completion
                   kb/basic-remote-all-completions
                   nil))
    :config
    ;; Manually load extension files
    (dolist (module '(vertico-indexed
                      vertico-flat
                      vertico-grid
                      vertico-mouse
                      vertico-quick
                      vertico-buffer
                      vertico-repeat
                      vertico-reverse
                      vertico-directory
                      vertico-multiform
                      vertico-unobtrusive))
      (require module))

    (vertico-mode)
    ;; Extensions
    (vertico-multiform-mode)

    ;; Prefix the current candidate with “» ”. From
    ;; https://github.com/minad/vertico/wiki#prefix-current-candidate-with-arrow
    (advice-add #'vertico--format-candidate :around
                (lambda (orig cand prefix suffix index _start)
                  (setq cand (funcall orig cand prefix suffix index _start))
                  (concat
                   (if (= vertico--index index)
                       (propertize "» " 'face 'vertico-current)
                     "  ")
                   cand))))
#+end_src

*** Orderless

#+begin_src emacs-lisp
  (use-package orderless
    :ensure t
    :custom
    (completion-styles '(orderless))
    (completion-category-defaults nil) ; I want to be in control!
    (completion-category-overrides
     '((file (styles basic-remote ; For `tramp' hostname completion with
                                  ; `vertico'
                     orderless
                     ))
       ))

    (orderless-component-separator 'orderless-escapable-split-on-space)
    (orderless-matching-styles
     '(orderless-literal
       orderless-prefixes
       orderless-initialism
       orderless-regexp
       ;; orderless-flex
       ;; orderless-strict-leading-initialism
       ;; orderless-strict-initialism
       ;; orderless-strict-full-initialism
       ;; orderless-without-literal          ; Recommended for dispatches instead
       ))
    (orderless-style-dispatchers
     '(prot-orderless-literal-dispatcher
       prot-orderless-strict-initialism-dispatcher
       prot-orderless-flex-dispatcher
       ))
    :init
    (defun orderless--strict-*-initialism (component &optional anchored)
      "Match a COMPONENT as a strict initialism, optionally ANCHORED.
  The characters in COMPONENT must occur in the candidate in that order at
  the beginning of subsequent words comprised of letters. Only non-letters
  can be in between the words that start with the initials.

  If ANCHORED is `start' require that the first initial appear in the
  first word of the candidate. If ANCHORED is `both' require that the
  first and last initials appear in the first and last words of the
  candidate, respectively."
      (orderless--separated-by
          '(seq (zero-or-more alpha) word-end (zero-or-more (not alpha)))
        (cl-loop for char across component collect `(seq word-start ,char))
        (when anchored '(seq (group buffer-start) (zero-or-more (not alpha))))
        (when (eq anchored 'both)
          '(seq (zero-or-more alpha) word-end (zero-or-more (not alpha)) eol))))

    (defun orderless-strict-initialism (component)
      "Match a COMPONENT as a strict initialism.
  This means the characters in COMPONENT must occur in the candidate in
  that order at the beginning of subsequent words comprised of letters.
  Only non-letters can be in between the words that start with the
  initials."
      (orderless--strict-*-initialism component))

    (defun prot-orderless-literal-dispatcher (pattern _index _total)
      "Literal style dispatcher using the equals sign as a suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless parses
  its input."
      (when (string-suffix-p "=" pattern)
        `(orderless-literal . ,(substring pattern 0 -1))))

    (defun prot-orderless-strict-initialism-dispatcher (pattern _index _total)
      "Leading initialism  dispatcher using the comma suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless parses
  its input."
      (when (string-suffix-p "," pattern)
        `(orderless-strict-initialism . ,(substring pattern 0 -1))))

    (defun prot-orderless-flex-dispatcher (pattern _index _total)
      "Flex  dispatcher using the tilde suffix.
  It matches PATTERN _INDEX and _TOTAL according to how Orderless parses
  its input."
      (when (string-suffix-p "." pattern)
        `(orderless-flex . ,(substring pattern 0 -1))))
    )
#+end_src

*** Corfu

#+begin_src emacs-lisp
  (use-package corfu
    :ensure t
    ;; Optional customizations
    :custom
    (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
    (corfu-auto nil)
    (corfu-auto-delay 0.2)
    (corfu-auto-prefix 3)

    ;; (corfu-separator ?\s)          ;; (M-SPC) Orderless field separator
    ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
    (corfu-quit-no-match t)
    ;; (corfu-preview-current nil)    ;; Disable current candidate preview
    ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
    ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
    ;; (corfu-scroll-margin 5)        ;; Use scroll margin

    ;; Enable Corfu only for certain modes.
    ;; :hook ((prog-mode . corfu-mode)
    ;;        (shell-mode . corfu-mode)
    ;;        (eshell-mode . corfu-mode))

    ;; Popup info
    ;; Display information about current completion item after 0.2 seconds.
    (corfu-popupinfo-delay 0.2)

    ;; Keybindings
    (global-set-key (kbd "C-M-i") #'corfu-complete) ; To invoke completion
                                                    ; manually.

    :bind
    (:map corfu-map (("SPC" . corfu-insert-separator)
                     ("RET" . nil)
                     ("M-n" . corfu-next)
                     ("M-p" . corfu-previous)
                     ("C-M-i" . corfu-insert)))

    ;; Recommended: Enable Corfu globally.
    ;; This is recommended since Dabbrev can be used globally (M-/).
    ;; See also `corfu-exclude-modes'.
    :init
    (global-corfu-mode)
    (corfu-popupinfo-mode))

  ;; A few more useful configurations...
  (use-package emacs
    :ensure nil
    :init
    ;; TAB cycle if there are only few candidates
    (setopt completion-cycle-threshold 3)

    ;; Emacs 28: Hide commands in M-x which do not apply to the current mode.
    ;; Corfu commands are hidden, since they are not supposed to be used via M-x.
    ;; (setq read-extended-command-predicate
    ;;       #'command-completion-default-include-p)

    (setopt tab-always-indent t))
#+end_src

**** Nerd icons for Corfu

#+begin_src emacs-lisp
  (use-package nerd-icons-corfu
    :ensure t
    :after corfu
    :config
    (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src

*** Cape

#+begin_src emacs-lisp
  ;; Add extensions
  (use-package cape
    :ensure t
    ;; Bind dedicated completion commands
    ;; Alternative prefix keys: C-c p, M-p, M-+, ...
    :bind (("C-c p p" . completion-at-point) ;; capf
           ("C-c p t" . complete-tag)        ;; etags
           ("C-c p d" . cape-dabbrev)        ;; or dabbrmy-completion
           ("C-c p h" . cape-history)
           ("C-c p f" . cape-file)
           ("C-c p k" . cape-keyword)
           ("C-c p s" . cape-symbol)
           ("C-c p a" . cape-abbrev)
           ("C-c p l" . cape-line)
           ("C-c p w" . cape-dict)
           ("C-c p \\" . cape-tex)
           ("C-c p _" . cape-tex)
           ("C-c p ^" . cape-tex)
           ("C-c p &" . cape-sgml)
           ("C-c p r" . cape-rfc1345))
    :init
    ;; Add `completion-at-point-functions', used by `completion-at-point'.
    ;; NOTE: The order matters!
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-to-list 'completion-at-point-functions #'cape-elisp-block)
    ;;(add-to-list 'completion-at-point-functions #'cape-history)
    ;;(add-to-list 'completion-at-point-functions #'cape-keyword)
    ;;(add-to-list 'completion-at-point-functions #'cape-tex)
    ;;(add-to-list 'completion-at-point-functions #'cape-sgml)
    ;;(add-to-list 'completion-at-point-functions #'cape-rfc1345)
    ;;(add-to-list 'completion-at-point-functions #'cape-abbrev)
    ;;(add-to-list 'completion-at-point-functions #'cape-dict)
    ;;(add-to-list 'completion-at-point-functions #'cape-symbol)
    ;;(add-to-list 'completion-at-point-functions #'cape-line)
    )
#+end_src

*** Kind-icon

Note: See [[https://github.com/jdtsmith/kind-icon/issues/34#issuecomment-1668560185][this]] post for handling theme changes.

#+begin_src emacs-lisp
  (use-package kind-icon
    :ensure t
    :after corfu
    :custom
    (kind-icon-use-icons t)
    (kind-icon-default-face 'corfu-default) ; to compute blended backgrounds
                                            ; correctly
    (kind-icon-blend-background nil)  ; Use midpoint color between foreground and
                                      ; background colors ("blended")?
    (kind-icon-blend-frac 0.08)
    (kind-icon-default-style
     '(:padding -1 :stroke 0 :margin 0 :radius 0 :height 0.5 :scale 1.0))
    (kind-icon-formatted 'variable)
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

*** Snippets

#+begin_src emacs-lisp
  (use-package yasnippet
    :ensure t
    :init
    (setopt yas-snippet-dirs
            `(,(concat user-emacs-directory
                       (file-name-as-directory "snippets"))))

    :hook
    ;; still have to manually activate the mode for some reason...
    (snippet-mode . (lambda ()
                      (set (make-local-variable 'require-final-newline) nil)))
    :config
    (yas-global-mode 1))
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet-snippets
    :after yasnippet
    :ensure t)
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet-capf
    :ensure t
    :after cape
    :config
    (add-to-list 'completion-at-point-functions #'yasnippet-capf))
#+end_src

** LSP

*** Eglot

#+begin_src emacs-lisp
  (use-package flymake :ensure t)

  (use-package eglot
    :ensure t
    :after (general flymake)
    :general (my-leader-keys "c a" 'eglot-code-actions)
    :custom
    (eglot-autoshutdown t)
    (eglot-ignored-server-capabilities '(:inlayHintProvider
                                         :documentOnTypeFormattingProvider)))
#+end_src

#+begin_src emacs-lisp
  (use-package flycheck-eglot
    :ensure t
    :after (flycheck eglot)
    :custom (flycheck-eglot-exclusive nil) ; cooperate with checkers in addition
                                           ; to eglot
    :config
    (global-flycheck-eglot-mode 1))
#+end_src

**** Dependencies

#+begin_src emacs-lisp
  (use-package jsonrpc :ensure t)
#+end_src

** Language configuration

*** Treesitter

**** Lower font lock level to reduce the fruit salad (disabled)

#+begin_src emacs-lisp :tangle no
  (setopt treesit-font-lock-level 2) ; default: 3
#+end_src

**** treesit-auto (disabled)

#+begin_src emacs-lisp :tangle no
  (use-package treesit-auto
    :ensure t
    :custom
    (treesit-auto-install 'prompt)
    :config
    (treesit-auto-add-to-auto-mode-alist 'all)
    (global-treesit-auto-mode))
#+end_src

*** Rust

**** Rust-mode

#+begin_src emacs-lisp
  (use-package rust-mode
    :ensure t
    :init
    (setq rust-mode-treesitter-derive t
          rust-format-on-save t)
    :mode ("\\.rs\\'" . rust-mode)
    :hook ((rust-mode . (lambda () (setopt indent-tabs-mode nil)))
           (rust-mode . eglot-ensure)))
#+end_src

**** Flycheck

#+begin_src emacs-lisp
  (use-package flycheck-rust
    :ensure t
    :after (rust-mode flycheck)
    :hook (flycheck-mode . flycheck-rust-setup))
#+end_src

*** Prolog

Use prolog-mode instead of perl-mode for .pl files.

#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.pl?\\'" . prolog-mode))
#+end_src

*** YAML

#+begin_src emacs-lisp
  (use-package yaml-mode
    :ensure t
    :hook
    (yaml-mode . (lambda ()
                   (define-key yaml-mode-map "\C-m" 'newline-and-indent))))
#+end_src

*** Markdown

#+begin_src emacs-lisp
  (use-package markdown-mode
    :ensure t
    :demand t
    :mode ("\\.md\\'" . gfm-mode)
    :init
    (setopt markdown-command "pandoc"
            markdown-header-scaling nil
            markdown-enable-math t
            markdown-make-gfm-checkboxes-buttons t
            markdown-fontify-code-blocks-natively t
            markdown-asymmetric-header t)
    :config
    (add-to-list 'markdown-code-lang-modes '("js" . js-ts-mode)))
#+end_src

**** Convert Markdown to Org

#+begin_src emacs-lisp
  (defun cc/markdown-to-org-region (start end)
    "Convert Markdown formatted text in region (START, END) to Org.

  This command requires that pandoc (man page `pandoc(1)') be installed."
    (interactive "r")
    (shell-command-on-region
     start end
     "pandoc -f markdown -t org --wrap=preserve" t t))
#+end_src

*** Clojure

#+begin_src emacs-lisp
  (use-package clojure-mode :ensure t)

  (use-package aggressive-indent
    :ensure t
    :hook '(clojure-mode
            elisp-mode
            emacs-lisp-mode
            lisp-mode
            common-lisp-mode
            scheme-mode))

  (use-package smartparens
    :ensure t
    :init (require 'smartparens-config)
    :hook (clojure-mode . smartparens-mode))

  ;; Invoke the nREPL with `cider-jack-in' when visiting a file inside a clojure
  ;; project.
  (use-package cider
    :ensure t
    :init
    ;; Open a REPL buffer without switching focus to it when Cider is invoked.
    (setopt cider-repl-pop-to-buffer-on-connect 'display-only)

    ;; Auto-trim REPL large buffer.
    (setopt cider-repl-buffer-size-limit 100000)
    :hook
    ;; Keep prompt on bottom line when output is printed.
    (cider-repl-mode . (lambda ()
                         (setopt scroll-conservatively 101))))
#+end_src

*** Common Lisp

#+begin_src emacs-lisp
  (use-package sly
    :ensure t
    :init (setq inferior-lisp-program (executable-find "sbcl"))
    :mode ("\\.lisp?\\'" . common-lisp-mode)
    :hook
    (sly-mode . (lambda ()
                  (unless (sly-connected-p)
                    (save-excursion (sly))))))
#+end_src

*** Typescript

#+begin_src emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.tsx?\\'" . tsx-ts-mode))
#+end_src

*** Web

#+begin_src emacs-lisp
  (use-package web-mode :ensure t)
#+end_src

*** jq

Info about interactive use in a JSON buffer, Org-babel support and how to use with yq for yaml provided [[https://github.com/ljos/jq-mode][here]].

#+begin_src emacs-lisp
  (use-package jq-mode
    :ensure t
    :mode ("\\.jq\\'" . jq-mode))
#+end_src

*** HTTP

**** restclient.el

This package provides a simple way to interact with RESTful APIs from within Emacs. [[https://emacsrocks.com/e15.html][This]] /Emacs Rocks!/ episode highlights some of its features.

Notable keymaps:

| Keymap  | Command description                                     |
|---------+---------------------------------------------------------|
| C-c C-c | Send request at point                                   |
| C-c C-j | Run jq interactively on restclient json response buffer |

#+begin_src emacs-lisp
  (use-package restclient
    :ensure t
    :mode ("\\.http\\'" . restclient-mode))

  ;; Below makes sure that restclient-jq can be required which is a must if we
  ;; want to be able to use jq related tasks.
  (use-package restclient-jq
    :ensure t
    :after restclient
    :config (require 'restclient-jq))
#+end_src

**** Hurl

#+begin_src emacs-lisp
  (use-package hurl-mode
    :ensure (:host github :repo "jaszhe/hurl-mode")
    :mode "\\.hurl\\'")
#+end_src

*** Mermaid

#+begin_src emacs-lisp
  (use-package mermaid-mode :ensure t :mode "\\.mmd$")
#+end_src

*** Lua

#+begin_src emacs-lisp
  (use-package lua-mode
    :ensure t
    :mode "\\.lua\\'"
    :config
    (with-eval-after-load 'eglot
      (add-to-list 'eglot-server-programs
                   '((lua-mode lua-ts-mode) . ("lua-language-server"))))
    (add-to-list 'project-vc-extra-root-markers ".busted")
    :hook (lua-mode . eglot-ensure))
#+end_src

*** OCaml

Tuareg is a mode for Emacs that improves the OCaml editing experience.

#+begin_src emacs-lisp
  (use-package tuareg :ensure t)
#+end_src

#+begin_src emacs-lisp
  ;; OCaml configuration
  ;;  - better error and backtrace matching

  (defun set-ocaml-error-regexp ()
    (set
     'compilation-error-regexp-alist
     (list '("[Ff]ile \\(\"\\(.*?\\)\", line \\(-?[0-9]+\\)\\(, characters \\(-?[0-9]+\\)-\\([0-9]+\\)\\)?\\)\\(:\n\\(\\(Warning .*?\\)\\|\\(Error\\)\\):\\)?"
             2 3 (5 . 6) (9 . 11) 1 (8 compilation-message-face)))))

  (add-hook 'tuareg-mode-hook 'set-ocaml-error-regexp)
  (add-hook 'caml-mode-hook 'set-ocaml-error-regexp)
#+end_src

*** Docker

#+begin_src emacs-lisp
  (use-package dockerfile-mode :ensure t)
#+end_src

*** CSV

#+begin_src emacs-lisp
  (use-package csv-mode
    :ensure t
    :mode "\\.csv\\'")
#+end_src

*** Shell

#+begin_src emacs-lisp :tangle no
  (defun my-maybe-load-bash-ts-mode ()
    "Load bash-ts-mode if the file starts with #!/bin/bash or #!/bin/env
  bash."
    (when (buffer-file-name)
      (save-excursion
        (goto-char (point-min))
        (when (looking-at "#!/bin/bash")
          (bash-ts-mode)))))

  (add-hook 'find-file-hook 'my-maybe-load-bash-ts-mode)
#+end_src

**** Indentation of 2 spaces is good practice in modern shell scripts

#+begin_src emacs-lisp
  (setopt sh-basic-offset 2)
#+end_src

*** C

#+begin_src emacs-lisp
  ;; (setopt c-ts-mode-indent-style 'linux
  ;;         c-ts-mode-indent-offset 4)
  ;; (add-hook 'c-ts-mode-hook (lambda () (c-ts-mode-toggle-comment-style -1)))
  (setq c-default-style '((java-mode . "java")
                          (awk-mode . "awk")
                          (other . "linux")))
  (setq-default c-basic-offset 4)
  (add-hook 'c-mode-hook (lambda () (setq indent-tabs-mode nil)))
  (add-hook 'c-mode-hook (lambda () (c-toggle-comment-style -1)))
#+end_src

** Syntax checking

#+begin_src emacs-lisp
  (use-package flycheck
    :ensure t
    :init (global-flycheck-mode))
#+end_src

#+begin_src emacs-lisp
  (use-package consult-flycheck :ensure t)
#+end_src

** Formatting

*** Apheleia

#+begin_src emacs-lisp
  (use-package apheleia
    :ensure t
    :config
    ;; Python
    (setf (alist-get 'python-mode apheleia-mode-alist)
          '(ruff-isort ruff))
    (setf (alist-get 'python-ts-mode apheleia-mode-alist)
          '(ruff-isort ruff)))
#+end_src

*** fill-column

#+begin_src emacs-lisp
  (add-hook 'prog-mode-hook (lambda () (setq fill-column 80)))
#+end_src

** Git

*** Magit

#+begin_src emacs-lisp
  (use-package magit
    :ensure t
    :custom
    ;; Make Magit the only window in the frame when invoked.
    (magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)

    ;; Restore previous layout when exiting Magit.
    (magit-bury-buffer-function #'magit-restore-window-configuration)

    :general
    (my-leader-keys
      "g g" 'magit-status
      "g i" 'magit-info
      "g l" 'magit-log))

  (use-package forge
    :ensure t
    :after (general magit))
#+end_src

*** diff-hl

#+begin_src emacs-lisp
  (use-package diff-hl
    :ensure t
    :init
    (global-diff-hl-mode)
    (diff-hl-flydiff-mode) ; update diff-hl on the fly
    (add-hook 'dired-mode-hook 'diff-hl-dired-mode) ; show diff in dired
    :hook
    (magit-pre-refresh . diff-hl-magit-pre-refresh)
    (magit-post-refresh . diff-hl-magit-post-refresh))
#+end_src

** Shell

*** Eshell

https://www.masteringemacs.org/article/complete-guide-mastering-eshell

**** Base

#+begin_src emacs-lisp
  (setq eshell-banner-message ""
        eshell-cmpl-cycle-completions t
        eshell-cmpl-ignore-case t
        eshell-destroy-buffer-when-process-dies nil
        eshell-error-if-no-glob t
        eshell-glob-case-insensitive t
        eshell-kill-processes-on-exit t
        eshell-scroll-to-bottom-on-input 'all
        eshell-scroll-to-bottom-on-output 'all
        eshell-scroll-show-maximum-output nil)
#+end_src

**** Syntax-highlighting

#+begin_src emacs-lisp
  (use-package eshell-syntax-highlighting
    :ensure t
    :defer t
    :hook (eshell-mode . eshell-syntax-highlighting-mode))
#+end_src

**** Setup visual commands

#+begin_src emacs-lisp
  (add-hook 'eshell-first-time-mode-hook
            (lambda ()
              (add-to-list 'eshell-visual-options
                           '("git" "--help" "--paginate"))
              (add-to-list 'eshell-visual-subcommands
                           '("git" "log" "diff" "show"))))
#+end_src

**** History

#+begin_src emacs-lisp
  (setopt eshell-history-size 10000
          eshell-hist-ignoredups t
          ;; Ignore input beginning with whitespace.
          eshell-input-filter (lambda (input)
                                (not (string-match-p "\\`\\s-+" input)))
          eshell-history-append t)
#+end_src

**** Keybinds

#+begin_src emacs-lisp
  (global-set-key (kbd "<f12>") 'eshell)

  (add-hook 'eshell-mode-hook
            (lambda ()
              (define-key eshell-mode-map (kbd "C-a") 'eshell-bol)
              (define-key eshell-mode-map (kbd "C-u") 'eshell-kill-input)))
#+end_src

**** Prompt

#+begin_src emacs-lisp
  (setq system-name (car (split-string system-name "\\.")))
  (setq eshell-prompt-regexp "^.+@.+:.+> ")
  (setq eshell-prompt-function
        (lambda ()
          (concat
           (propertize (user-login-name) 'face 'font-lock-keyword-face)
           (propertize (format "@%s" (system-name)) 'face 'default)
           (propertize ":" 'face 'font-lock-doc-face)
           (propertize (abbreviate-file-name (eshell/pwd)) 'face 'font-lock-type-face)
           (propertize "$" 'face 'font-lock-doc-face)
           (propertize " " 'face 'default))))
#+end_src

**** Scroll behavior

#+begin_src emacs-lisp
  (add-hook 'eshell-mode-hook
          (lambda ()
            (setq-local scroll-margin 1)))
#+end_src

*** Eat

#+begin_src emacs-lisp
  (use-package eat
    :ensure t
    :after general
    :general
    (my-leader-keys "` e" 'eshell)
    (my-leader-keys "` a" 'eat)
    :custom
    (eat-term-name "xterm-256color")
    (eat-kill-buffer-on-exit t)

    :hook ((eshell-load . eat-eshell-mode)
           (eshell-load . eat-eshell-visual-command-mode)))

  (global-set-key (kbd "S-<f12>") 'eat)
#+end_src

*** Atuin

=atuin= stores shell history in a database, which allows for having the same history across multiple shells, sessions, and optionally across different machines.

#+begin_src emacs-lisp
  (use-package eshell-atuin
    :ensure t
    :after eshell
    :bind (:map eshell-mode-map
                ("C-r" . eshell-atuin-history))
    :hook (eshell-mode . eshell-atuin-mode))
#+end_src

*** Ansi-term

#+begin_src emacs-lisp
  (global-set-key (kbd "C-<f12>") 'ansi-term)
#+end_src

** Project

#+begin_src emacs-lisp
  (use-package project
    :ensure nil
    :general
    (my-leader-keys
      ;; leader prefix for built-in project.el
      "p" '(:keymap project-prefix-map :wk "project"))
    :custom
    (project-mode-line t))
#+end_src

[[https://www.patrickdelliott.com/emacs.d/#org0a74aa5][source]]

** File exploration

*** Dired

#+begin_src emacs-lisp
  (use-package dired
    :ensure nil ; built-in
    :general
    (my-leader-keys
      "d d" 'dired
      "d j" 'dired-jump
      "d w" '((lambda () (interactive) (dired denote-workdir))
              :wk "Dired to work notes"))
    :config
    (when (string= system-type "darwin")
      (setopt dired-use-ls-dired t
              insert-directory-program "/opt/homebrew/bin/gls"))
    :hook
    (dired-mode . dired-hide-details-mode)
    :custom
    (dired-listing-switches "-aBhl --group-directories-first")
    (dired-create-destination-dirs t)
    ;; Rename files using `vc-rename-file' if files are under version control.
    (dired-vc-rename-file t))
#+end_src

**** Dired-single

#+begin_src emacs-lisp
  (use-package dired-single
    :ensure (:host github :repo "emacsattic/dired-single"))
#+end_src

**** Open eshell in Dired directory

#+begin_src emacs-lisp
  (with-eval-after-load 'dired
    (define-key dired-mode-map "`" (lambda () (interactive) (eshell))))
#+end_src

**** Open file when pressing enter during search

#+begin_src emacs-lisp
  (defadvice isearch-exit (after dired-enter-directory-or-file activate)
    "In dired mode, enter directory or open file after isearch."
    (when (eq major-mode 'dired-mode)
      (let ((file (dired-get-file-for-visit)))
        (when file
          (dired-find-file)))))
#+end_src

**** Display git logs in dired

#+begin_src emacs-lisp
  (use-package dired-git-info
    :ensure t
    :bind (:map dired-mode-map
                (")" . dired-git-info-mode)))
#+end_src

**** Dired subtree

Drill down subdirectories in dired.

#+begin_src emacs-lisp
  (use-package dired-subtree
    :ensure t
    :after dired
    :bind (:map dired-mode-map
                ("<tab>" . dired-subtree-toggle)
                ("<backtab>" . dired-subtree-cycle)))
#+end_src

*** Hide/show hidden files

#+begin_src emacs-lisp
  (use-package dired-hide-dotfiles :ensure t)
#+end_src

*** Treemacs

Treemacs is an Emacs package that provides a customizable, tree-style file explorer and project manager, streamlining file navigation and organization.

#+begin_src emacs-lisp
  (use-package treemacs
    :ensure t
    :after general
    :defer t
    :general (my-leader-keys "f e" 'treemacs))

  (use-package treemacs-magit
    :ensure t
    :after (treemacs magit))

  (use-package treemacs-nerd-icons
    :ensure t
    :after (treemacs nerd-icons)
    :config (treemacs-load-theme "nerd-icons"))
#+end_src

*** Consult dir

Jump to previously visited directory, not unlike using =zoxide=.

#+begin_src emacs-lisp
  (use-package consult-dir
    :ensure t
    :bind (("C-x C-d" . consult-dir)
           :map vertico-map
           ("C-x C-d" . consult-dir)
           ("C-x C-j" . consult-dir-jump-file)))

  ;; https://karthinks.com/software/jumping-directories-in-eshell/
  (defun eshell/z (&optional regexp)
    "Navigate to a previously visited directory in eshell, or to any
   directory proferred by `consult-dir'."
    (let ((eshell-dirs (delete-dups
                        (mapcar 'abbreviate-file-name
                                (ring-elements eshell-last-dir-ring)))))
      (cond
       ((and (not regexp) (featurep 'consult-dir))
        (let* ((consult-dir--source-eshell `(:name "Eshell"
                                                   :narrow ?e
                                                   :category file
                                                   :face consult-file
                                                   :items ,eshell-dirs))
               (consult-dir-sources (cons consult-dir--source-eshell
                                          consult-dir-sources)))
          (eshell/cd (substring-no-properties
                      (consult-dir--pick "Switch directory: ")))))
       (t (eshell/cd (if regexp (eshell-find-previous-directory regexp)
                       (completing-read "cd: " eshell-dirs)))))))
#+end_src

*** Zoxide

#+begin_src emacs-lisp
  (use-package zoxide
    :ensure t
    :after general
    :hook (dired-mode . zoxide-add)
    :general
    (my-leader-keys
      "d z" '(zoxide-travel :wk "Find directory with Zoxide")))
#+end_src

** Editorconfig

#+begin_src emacs-lisp
  (use-package editorconfig
    :ensure t
    :config (editorconfig-mode 1))
#+end_src

** Search

*** Consult

#+begin_src emacs-lisp
  ;; Example configuration for Consult
  (use-package consult
    :ensure t
    :after general
    :general
    (my-leader-keys
      "s g" 'consult-git-grep
      "s s" 'consult-ripgrep
      "s l" 'consult-line
      "s L" 'consult-line-multi)
    ;; Replace bindings. Lazily loaded by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g r" . consult-grep-match)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setq register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep consult-man
     consult-bookmark consult-recent-file consult-xref
     consult-source-bookmark consult-source-file-register
     consult-source-recent-file consult-source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (keymap-set consult-narrow-map (concat consult-narrow-key " ?") #'consult-narrow-help)
    )
#+end_src

*** Anzu

Display number of matches in modeline when searching.

#+begin_src emacs-lisp
  (use-package anzu
    :ensure t
    :config
    (global-anzu-mode))
#+end_src

*** Avy

#+begin_src emacs-lisp
  (global-set-key (kbd "C-:") 'avy-goto-char-timer)
#+end_src

*** Deadgrep

Starts an interactive ripgrep session.

#+begin_src emacs-lisp
  (use-package deadgrep
    :ensure t
    :bind ("M-s M-s" . deadgrep))
#+end_src

** Org

*** Base

#+begin_src emacs-lisp
  (use-package org
    :ensure nil
    :init
    (setopt org-directory (expand-file-name "~/Documents/org")
            org-default-notes-file (concat org-directory "/inbox.org")
            org-work-notes-file (concat org-directory "/work.org")
            org-projects-file (concat org-directory "/projects.org")
            org-journelly-file (concat org-directory "/Journelly.org")
            org-links-file (concat org-directory "/links.org")
            org-agenda-files (list org-default-notes-file
                                   org-work-notes-file
                                   org-projects-file
                                   (concat org-directory "/calendar-beorg.org")
                                   (concat org-directory "/home.org")))

    (require 'org-indent)

    :custom
    (org-return-follows-link nil)
    (org-startup-with-inline-images t)
    ;; (org-fontify-quote-and-verse-blocks t)
    (org-image-actual-width '(300))
    (org-pretty-entities t)
    ;; (org-auto-align-tags nil)
    (org-tags-column 0) ; Place tags directly after headline text.
    (org-agenda-tags-column 0)
    (org-fold-catch-invisible-edits 'show-and-error)
    (org-special-ctrl-a/e t)
    (org-insert-heading-respect-content t)
    (org-startup-indented t)
    ;; (org-M-RET-may-split-line '((default . nil)))

    (org-log-done 'note)
    (org-log-into-drawer t)

    ;; Ask how many minutes to keep if idle for at least 15 minutes.
    (org-clock-idle-time 15)

    (org-reverse-note-order t)

    (org-capture-templates
     '(("l" "Journelly")
       ("lm" "New journe(l)ly note with metadata" entry
        (file org-journelly-file)
        "* %U @ %(journelly-generate-metadata)\n%?" :prepend t)
       ("lp" "New plain journe(l)ly note" entry
        (file org-journelly-file)
        "* %U @ -\n%?" :prepend t)

       ("m" "Meetings")
       ("mm" "Meetings - Mio" entry
        (file+olp org-work-notes-file "Mio" "Meetings")
        "* %^T %?" :empty-lines 1 :prepend t)

       ("n" "Notes")

       ("t" "Tasks")
       ("tt" "New inbox task" entry
        (file org-default-notes-file)
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("te" "New Emacs task" entry
        (file+olp org-projects-file "Emacs")
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("tl" "New Learn task" entry
        (file+olp org-projects-file "Learn")
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("td" "New Dev task" entry
        (file+olp org-projects-file "Dev")
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("th" "New Homelab task" entry
        (file+olp org-projects-file "Homelab")
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("td" "New Other task" entry
        (file+olp org-projects-file "Other")
        "* TODO %i%?" :empty-lines 1 :prepend t)
       ("tw" "Work tasks")
       ("twm" "New Mio task" entry
        (file+olp org-work-notes-file "Mio" "Tasks")
        "* TODO %i%?\n%a\n" :empty-lines 1 :prepend t)

       ("w" "Web link" plain
        (file+function org-links-file
                       (lambda () (goto-char (point-min))))
        "* %^{Title}
  :PROPERTIES:
  :TITLE: %\\1
  :AUTHOR: %^{Author}
  :URL: %^{URL}
  :DATE_CAPTURED: %U
  :END:
  %?
  " :empty-lines 1 :prepend t)))

    (org-refile-targets
     '((org-agenda-files :maxlevel . 4)
       (nil :maxlevel . 4)))

    (org-refile-use-outline-path t)
    (org-refile-allow-creating-parent-nodes 'confirm)
    (org-refile-use-cache t)

    (org-todo-keywords
     '((sequence "TODO(t)" "NEXT(n!)" "WAIT(w@/!)" "|" "DONE(d!)" "CANX(c@/!)")))

    (org-preview-latex-default-process 'dvisvgm)

    :bind (("C-c l" . org-store-link)
           ("C-c a" . org-agenda)
           ("C-c c" . org-capture))

    :general (my-leader-keys
               "o b t" 'org-babel-tangle
               "o l d" 'org-toggle-link-display)
    :hook
    ((org-mode markdown-mode) . (lambda ()
                                  (display-line-numbers-mode -1))))
#+end_src

*** Appear

This package displays hidden emphasis markers while the cursor is on a rich text word.

#+begin_src emacs-lisp
  (use-package org-appear
    :ensure t
    :after general
    :config
    (setopt org-appear-autoemphasis t
            org-hide-emphasis-markers t
            org-appear-autolinks t
            org-appear-autosubmarkers t
            org-appear-autoentities t
            org-appear-autokeywords t
            org-appear-inside-latex t)
    :hook (org-mode . org-appear-mode)
    :general (my-leader-keys "o m a" 'org-appear-mode)) ; org->mode->appear
#+end_src

*** Babel

#+begin_src emacs-lisp
  (setopt org-confirm-babel-evaluate nil
          org-src-fontify-natively t
          org-src-tab-acts-natively t)

  (defconst load-language-alist
    '((emacs-lisp . t)
      (C          . t)
      (css        . t)
      (java       . t)
      (js         . t)
      (lua        . t)
      (ocaml      . t)
      (perl       . t)
      (plantuml   . t)
      (python     . t)
      (ruby       . t)
      (sass       . t)
      (shell      . t))
    "Alist of org ob languages.")
  (org-babel-do-load-languages 'org-babel-load-languages
                               load-language-alist)
#+end_src

*** Add timestamp

#+begin_src emacs-lisp
  (defun my-org-timestamp-inactive (&optional arg)
    "Insert current time as inactive timestamp without prompting.
  With prefix argument, insert as heading at current org heading level.
  With two prefix arguments, insert as top-level heading."
    (interactive "P")
    (cond
     ((equal arg '(16))  ; C-u C-u - top level heading
      (beginning-of-line)
      (insert "* ")
      (org-timestamp-inactive '(16))
      (newline))
     ((equal arg '(4))   ; C-u - current level heading
      (let ((level (or (org-current-level) 1)))
        (beginning-of-line)
        (insert (make-string level ?*) " ")
        (org-timestamp-inactive '(16))
        (newline)))
     (t  ; No prefix - inline timestamp
      (org-timestamp-inactive '(16)))))
#+end_src

*** Org-modern

#+begin_src emacs-lisp
  (use-package org-modern
    :ensure t
    :custom
    (org-modern-star nil)
    :config
    (global-org-modern-mode))
#+end_src

** Olivetti

Olivetti is a minor mode that provides a nice writing environment by setting comfortable window margins etc.

#+begin_src emacs-lisp
  (use-package olivetti
    :ensure t
    :after general
    :general
    (my-leader-keys "u o" 'olivetti-mode)
    :init
    (setopt olivetti-body-width 90
            olivetti-minimum-body-width 72)
    :hook ((org-mode markdown-mode) . olivetti-mode)
    :bind ("S-<f9>" . olivetti-mode))
#+end_src

** Denote

*** Base

Use denote for note-taking. Most of this is copied from Prot's config.

#+begin_src emacs-lisp
  (use-package denote
    :ensure t
    :demand t
    :init
    (setopt denote-directory (expand-file-name "~/Documents/notes/")
            denote-date-prompt-use-org-read-date t)

    (setq denote-workdir (expand-file-name "~/Documents/work-notes/mio/"))

    :config
    (setopt denote-file-type 'org)
    (denote-rename-buffer-mode 1)

    (with-eval-after-load 'org-capture
      (setopt denote-org-capture-specifiers "%l\n%i\n%?")
      (add-to-list 'org-capture-templates '("nd" "Denote"))
      (add-to-list 'org-capture-templates
                   '("ndn" "New note" plain
                     (file denote-last-path)
                     #'denote-org-capture
                     :no-save t
                     :immediate-finish nil
                     :kill-buffer t
                     :jump-to-captured t))

      ;; This prompts for TITLE, KEYWORDS, and SUBDIRECTORY
      (add-to-list 'org-capture-templates
                   '("ndp" "New note with prompts" plain
                     (file denote-last-path)
                     (function (lambda () (denote-org-capture-with-prompts
                                           :title :keywords :signature)))
                     :no-save t
                     :immediate-finish nil
                     :kill-buffer t
                     :jump-to-captured t)))

    :bind
    (("C-c n n" . denote)
     ("C-c n N" . denote-type)
     ("C-c n d" . denote-date)
     ("C-c n z" . denote-signature) ; "zettelkasten" mnemonic
     ("C-c n s" . denote-subdirectory)
     ("C-c n o" . denote-sort-dired) ; "order" mnemonic
     ("C-c n r" . denote-rename-file)
     ("C-c n i" . denote-link) ; "insert" mnemonic
     ("C-c n I" . denote-add-links)
     ("C-c n b" . denote-backlinks)
     ("C-c n f f" . denote-find-link)
     ("C-c n f b" . denote-find-backlink)
     ("C-c n R" . denote-rename-file-using-front-matter)
     :map dired-mode-map
     ("C-c C-d C-i" . denote-link-dired-marked-notes)
     ("C-c C-d C-r" . denote-dired-rename-marked-files)
     ("C-c C-d C-k" . denote-dired-rename-marked-files-with-keywords)
     ("C-c C-d C-f" . denote-dired-rename-marked-files-using-front-matter))
    :hook
    ((dired-mode . denote-dired-mode)
     (text-mode . denote-fontify-links-mode-maybe)))
#+end_src

*** Journal

#+begin_src emacs-lisp
  (use-package denote-journal
    :ensure t
    :demand t
    :after denote
    :custom
    (denote-journal-directory (expand-file-name "journal" denote-workdir))
    (denote-journal-title-format 'day-date-month-year)
    (denote-journal-keyword "journal")

    :config
    (with-eval-after-load 'org-capture
      (add-to-list 'org-capture-templates '("ndj" "Journal"))
      (add-to-list 'org-capture-templates
                   '("ndjd" "Daily" entry
                     (file denote-journal-path-to-new-or-existing-entry)
                     "* %U\n\n%?"
                     :kill-buffer t
                     :empty-lines 1))
      (add-to-list 'org-capture-templates
                   '("ndjw" "Weekly (Not implemented)"))
      (add-to-list 'org-capture-templates
                   '("ndjm" "Monthly (Not implemented)")))

    :bind
    (("C-c n j" . denote-journal-new-entry)
     ("C-c n J" . denote-journal-new-or-existing-entry)
     ("<f8>" . (lambda ()
                 (interactive)
                 (org-capture nil "ndjd")))))
#+end_src

*** Org

#+begin_src emacs-lisp
  (use-package denote-org
    :ensure t
    :demand t
    :after denote)
#+end_src

*** Markdown

#+begin_src emacs-lisp
  (use-package denote-markdown
    ;; TODO There is apparently Obsidian support. Maybe I could create a Silo or
    ;; something that is located at the Obsidian directory. Having the ability to
    ;; link my Obsidian notes with my denote(s) would be really nice. Definitely
    ;; going to look into this.
    :ensure t
    :demand t
    :after denote)
#+end_src

*** Silo

#+begin_src emacs-lisp
  (use-package denote-silo
    :ensure t
    :demand t
    :after denote
    :custom
    (denote-silo-directories (list denote-directory denote-workdir))
    :bind
    (("C-c N d" . denote-silo-dired)
     ("C-c N n" . denote-silo-open-or-create)
     ("C-c N N" . denote-silo-select-silo-then-command)
     ("C-c N c" . denote-silo-cd)))
#+end_src

*** Denote explore

Auxiliary functions to manage and explore denote files: https://lucidmanager.org/productivity/denote-explore/.

#+begin_src emacs-lisp
  (use-package denote-explore
    :ensure t
    :after denote
    :custom
    ;; Where to store network data and in which format
    (denote-explore-network-directory (concat denote-directory "/graphs/"))
    (denote-explore-network-filename "denote-network")
    ;; Output format
    (denote-explore-network-format 'graphviz)
    (denote-explore-network-graphviz-filetype "svg")
    ;; Exlude keywords or regex
    (denote-explore-network-keywords-ignore '("bib"))
    :bind
    (;; Statistics
     ("C-c n e c" . denote-explore-count-notes)
     ("C-c n e C" . denote-explore-count-keywords)
     ("C-c n e b" . denote-explore-keywords-barchart)
     ("C-c n e x" . denote-explore-extensions-barchart)
     ;; Random walks
     ("C-c n e r" . denote-explore-random-note)
     ("C-c n e l" . denote-explore-random-link)
     ("C-c n e k" . denote-explore-random-keyword)
     ;; Denote Janitor
     ("C-c n e d" . denote-explore-identify-duplicate-notes)
     ("C-c n e z" . denote-explore-zero-keywords)
     ("C-c n e s" . denote-explore-single-keywords)
     ("C-c n e o" . denote-explore-sort-keywords)
     ("C-c n e r" . denote-explore-rename-keywords)
     ;; Visualise denote
     ("C-c n e n" . denote-explore-network)
     ("C-c n e v" . denote-explore-network-regenerate)
     ("C-c n e D" . denote-explore-degree-barchart)))
#+end_src

*** Consult denote

#+begin_src emacs-lisp
  (use-package consult-denote
    :ensure t
    :bind
    (("C-c n c f" . consult-denote-find)
     ("C-c n c g" . consult-denote-grep))

    :custom
    (consult-denote-find-command 'consult-fd)
    (consult-denote-grep-command 'consult-ripgrep)

    :config
    (consult-denote-mode 1))
#+end_src

** Reading

*** PDF

Use PDF tools package to turn Emacs into a PDF viewer with annotation support etc.

#+begin_src emacs-lisp
  (use-package pdf-tools
    :ensure t
    :commands (pdf-loader-install)
    :mode "\\.pdf\\'"
    :bind (:map pdf-view-mode-map
                ("j" . pdf-view-next-line-or-next-page)
                ("k" . pdf-view-previous-line-or-previous-page))
    :init (pdf-loader-install)
    :config (add-to-list 'revert-without-query ".pdf")
    :hook (pdf-view-mode . (lambda () (interactive)
                             (display-line-numbers-mode -1))))
#+end_src

*** Epub

#+begin_src emacs-lisp
  (use-package nov
    :ensure t
    :mode
    ("\\.epub\\'" . nov-mode)
    :config
    (defun my-nov-mode-setup ()
      "Tweak nov-mode to our liking."
      (setq-local line-spacing 0.2
                  next-screen-context-lines 4
                  shr-use-colors t)
      (when (require 'visual-fill-column nil t)
        (setq-local visual-fill-column-center-text t
                    visual-fill-column-width 64
                    nov-text-width 106)
        (visual-fill-column-mode 1))
      (when (featurep 'hl-line-mode)
        (hl-line-mode -1))
      (my-reading-font-setup)
      (olivetti-mode)
      ;; Re-render with new display settings
      (nov-render-document))
    :hook
    (nov-mode . my-nov-mode-setup))
#+end_src

*** Org-noter

#+begin_src emacs-lisp
  (use-package org-noter
    :ensure t
    :custom
    ;; Directory where org-noter will look for note files if invoked in a
    ;; non-org-roam buffer
    (org-noter-notes-search-path '("~/Documents/notes/literature"))

    ;; Create highlight in pdf when creating note
    (org-noter-highlight-selected-text t)

    ;; Remember last read location in document
    (org-noter-auto-save-last-location t))
#+end_src

*** Organizing Literature

My main source of literature is the calibre folder in my file system. Calibre is the software I use for organizing and maintaining my digital library. Calibredb is a package that allows us to manage the Calibre library from within Emacs.

This package requires that calibredb is installed on the system (included with the Calibre app) as well as sqlite3.

#+begin_src emacs-lisp
  (use-package calibredb
    :ensure t
    :defer t
    :config
    (setq calibredb-root-dir "~/Documents/calibre"
          calibredb-db-dir (expand-file-name "metadata.db" calibredb-root-dir)
          calibredb-library-alist '(("~/Documents/calibre"))
          calibredb-format-all-the-icons t
          calibredb-size-show t))
#+end_src

*** Wallabag

#+begin_src emacs-lisp
  (use-package wombag
    :ensure (:host github :repo "karthink/wombag")
    :defer t
    :config
    (setq wombag-host (my-get-auth-keyword "wallabag" :domain)
          wombag-username (my-get-auth-keyword "wallabag" :user)
          wombag-password (my-get-auth-keyword "wallabag" :secret)
          wombag-client-id (my-get-auth-keyword "wallabag" :clientid)
          wombag-client-secret (my-get-auth-keyword "wallabag" :client-secret)))
#+end_src

** Embark

Package repo.

#+begin_src emacs-lisp
  (use-package embark
    :ensure t
    :after general
    :bind
    (("C->" . embark-act)         ;; C-S-.
     ("M-." . embark-dwim)        ;; M-. also is "go-to-definition but
                                  ;; embark-dwim does just that in that context
     ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

    :general
    (my-leader-keys
      "E E" 'embark-act
      "E h B" 'embark-bindings)

    ;; :init
    ;; Optionally replace the key help with a completing-read interface
    ;; (setq prefix-help-command #'embark-prefix-help-command)

    ;; Show the Embark target at point via Eldoc. You may adjust the Eldoc
    ;; strategy, if you want to see the documentation from multiple providers.
    ;; (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
    ;; (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

    :config
    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  (use-package embark-consult
    :ensure t
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** AI (disabled)

*** GPTel

GPTel allows us to talk with different LLMs from within Emacs.

#+begin_src emacs-lisp :tangle no
  (use-package gptel
    :ensure t
    :after general
    :config
    (setq-default gptel-model 'gpt-oss:20b
                  gptel-backend (gptel-make-ollama "Ollama"
                                  :host "localhost:11434"
                                  :stream t
                                  :models '(gpt-oss:20b))
                  gptel-default-mode 'org-mode)
    :general
    (my-leader-keys
      "a a" 'gptel
      "a g" 'gptel-menu
      "a s" 'gptel-send))
#+end_src

** Popper (disabled)

#+begin_src emacs-lisp :tangle no
  (use-package popper
    :ensure t
    :bind (("C-`"   . popper-toggle)
           ("M-`"   . popper-cycle)
           ("C-M-`" . popper-toggle-type))
    :init
    (defun my-popper-window-height (window)
      "Make popper windows cover 2/3 of frame height."
      (fit-window-to-buffer
       window
       (floor (* (frame-height) 2) 3)
       (floor (* (frame-height) 2) 3)))

    (setopt popper-reference-buffers
            '("\\*Messages\\*"
              "Output\\*$"
              "\\*Async Shell Command\\*"
              help-mode
              helpful-mode
              compilation-mode
              "^\\*eshell.*\\*$" eshell-mode ; eshell as a popup
              "^\\*shell.*\\*$"  shell-mode  ; shell as a popup
              "^\\*term.*\\*$"   term-mode   ; term as a popup
              "^\\*vterm.*\\*$"  vterm-mode  ; vterm as a popup
              "^\\*eat.*\\*$"    eat-mode    ; eat as a popup
              )
            popper-window-height #'my-popper-window-height)
    (popper-mode +1)
    (popper-echo-mode +1)) ; For echo area hints
#+end_src

** Insert timestamp at point

#+begin_src emacs-lisp
  (defun my-insert-timestamp ()
    "Insert timestamp with format [%H:%M] at point."
    (interactive)
    (insert (format-time-string "[%H:%M]")))
#+end_src

** Documentation

*** Devdocs

#+begin_src emacs-lisp
  (use-package devdocs
    :ensure t
    :after general
    :init
    (defun my-devdocs-lookup-thing-at-point ()
      "Look up definition of thing at point, using Devdocs."
      (interactive)
      (devdocs-lookup nil (thing-at-point 'symbol t)))
    :hook
    ((js-mode
      . (lambda () (setq-local devdocs-current-docs '("javascript"))))
     (markdown-mode
      . (lambda () (setq-local devdocs-current-docs '("markdown"))))
     ((elisp-mode emacs-lisp-mode)
      . (lambda () (setq-local devdocs-current-docs '("elisp"))))
     (dockerfile-mode
      . (lambda () (setq-local devdocs-current-docs '("docker"))))
     (vue-ts-mode
      . (lambda () (setq-local devdocs-current-docs '("vue~3"
                                                      "javascript"
                                                      "typescript")))))
    :general
    (my-leader-keys
      "h d l" 'devdocs-lookup
      "h d p" 'devdocs-peruse
      "h d i" 'devdocs-install
      "h d d" 'my-devdocs-lookup-thing-at-point))
#+end_src

*** Helpful

Helpful is basically =Help= with some extra features.

#+begin_src emacs-lisp
  (use-package helpful
    :ensure t
    :demand t
    :config
    ;; Note that the built-in `describe-function' includes both functions and
    ;; macros. `helpful-function' is functions only, so we provide
    ;; `helpful-callable' as a drop-in replacement.
    (global-set-key (kbd "C-h f") #'helpful-callable)

    (global-set-key (kbd "C-h v") #'helpful-variable)
    (global-set-key (kbd "C-h k") #'helpful-key)
    (global-set-key (kbd "C-h x") #'helpful-command)
    ;; Lookup the current symbol at point. C-c C-d is a common keybinding for
    ;; this in lisp modes.
    ;; (global-set-key (kbd "C-c C-d") #'helpful-at-point)

    ;; Look up *F*unctions (excludes macros).
    ;;
    ;; By default, C-h F is bound to `Info-goto-emacs-command-node'. Helpful
    ;; already links to the manual, if a function is referenced there.
    (global-set-key (kbd "C-h F") #'helpful-function)

    (global-set-key (kbd "C-h o") #'helpful-symbol))
#+end_src

*** shortdoc

#+begin_src emacs-lisp
  (use-package shortdoc
    :ensure nil
    :general
    (my-leader-keys
      "h s" 'shortdoc))
#+end_src

** TODOs

*** hl-todo

Highlights common "TODO" keywords.

#+begin_src emacs-lisp
  (use-package hl-todo
    :ensure t
    :hook ((prog-mode . hl-todo-mode)
           (conf-mode . hl-todo-mode)))
#+end_src

** Window management

*** Frame actions

#+begin_src emacs-lisp
  (global-set-key (kbd "C-c f m") 'toggle-frame-maximized)
  (global-set-key (kbd "C-c f f") 'toggle-frame-fullscreen)
  (global-set-key (kbd "C-c f t") 'transpose-frame)

  (defvar-keymap frame-actions-repeat-map
    :repeat t
    "m" #'toggle-frame-maximized
    "f" #'toggle-frame-fullscreen
    "t" #'transpose-frame)
#+end_src

*** Transpose frame

Transpose arrangement of frame windows (eg. horizontal to vertical).

#+begin_src emacs-lisp
  (use-package transpose-frame :ensure t)
#+end_src

*** Resize pixelwise

#+begin_src emacs-lisp
  (setopt frame-resize-pixelwise t)
#+end_src

*** Window actions

#+begin_src emacs-lisp
  (defun my-shrink-window-horizontally ()
    (interactive)
    (shrink-window-horizontally 8))
  (defun my-enlarge-window-horizontally ()
    (interactive)
    (enlarge-window-horizontally 8))
  (defun my-shrink-window ()
    (interactive)
    (shrink-window 8))
  (defun my-enlarge-window ()
    (interactive)
    (enlarge-window 8))

  (defvar-keymap window-actions-repeat-map
    :repeat t
    "h" #'my-shrink-window-horizontally
    "l" #'my-enlarge-window-horizontally
    "j" #'my-shrink-window
    "k" #'my-enlarge-window
    "=" #'balance-windows
    "-" #'shrink-window-if-larger-than-buffer
    "0" #'delete-window
    "1" #'delete-other-windows)

  (global-set-key (kbd "C-, w h") 'my-shrink-window-horizontally)
  (global-set-key (kbd "C-, w l") 'my-enlarge-window-horizontally)
  (global-set-key (kbd "C-, w j") 'my-shrink-window)
  (global-set-key (kbd "C-, w k") 'my-enlarge-window)
  (global-set-key (kbd "C-, w =") 'balance-windows)
  (global-set-key (kbd "C-, w -") 'shrink-window-if-larger-than-buffer)
#+end_src

** Buffers

#+begin_src emacs-lisp
  (defun nuke-all-buffers ()
    "Kill all buffers except for *scratch*."
    (interactive)
    (mapc
     (lambda (buffer)
       (kill-buffer buffer))
     (buffer-list))
    (delete-other-windows))

  (my-leader-keys "b K" 'nuke-all-buffers)
#+end_src

#+begin_src emacs-lisp
  (defun my-kill-buffer-and-delete-window ()
    "Kill the active buffer and delete the containing window."
    (interactive)
    (kill-buffer)
    (delete-window))

  (global-set-key (kbd "C-x M-k") 'my-kill-buffer-and-delete-window)
#+end_src

** Compilation

*** Scroll *compilation* buffer window as output appears

#+begin_src emacs-lisp
  (setq-default compilation-scroll-output t)
#+end_src

*** Keybindings

#+begin_src emacs-lisp
  (global-set-key (kbd "<f5>") 'compile)
  (global-set-key (kbd "S-<f5>") 'recompile)
  (global-set-key (kbd "C-<f5>") 'project-compile)
#+end_src

*** Enable ANSI color support

#+begin_src emacs-lisp
  (defun my-colorize-compilation-buffer ()
    (let ((inhibit-read-only t))
      (ansi-color-apply-on-region (point-min) (point-max))))

  (add-hook 'compilation-filter-hook 'my-colorize-compilation-buffer)
#+end_src

** Kubernetes

*** kubed

- https://github.com/eshelyaron/kubed
- https://eshelyaron.com/kubed.html

#+begin_src emacs-lisp
  (use-package kubed
    :ensure t
    :bind-keymap ("C-c K" . kubed-prefix-map)
    :bind (:map kubed-prefix-map ("t" . kubed-transient)))
#+end_src

** dir-config

Alternative to =.dir-locals= that allegedly is easier to maintain as =.dir-config= files use standard elisp code instead of nested alists.

#+begin_src emacs-lisp
  (use-package dir-config
    :ensure t
    :custom
    (dir-config-file-names '(".dir-config.el"))
    (dir-config-allowed-directories '("~/repos"))
    :config
    (dir-config-mode))
#+end_src

** Package management

*** Elpaca

**** Bindings

#+begin_src emacs-lisp
  (defvar-keymap elpaca-fetch-prefix-map
    :doc "Elpaca fetch prefix map."
    "f" #'elpaca-fetch
    "a" #'elpaca-fetch-all)

  (defvar-keymap elpaca-pull-prefix-map
    :doc "Elpaca pull prefix map."
    "f" #'elpaca-pull
    "a" #'elpaca-pull-all)

  (defvar-keymap elpaca-prefix-map
    :doc "Elpaca prefix map."
    "b" #'elpaca-browse
    "f" elpaca-fetch-prefix-map
    "F" elpaca-pull-prefix-map
    "i" #'elpaca-info
    "l" #'elpaca-log
    "t" #'elpaca-try)

  (keymap-set global-map "C-c P" elpaca-prefix-map)

  (which-key-add-keymap-based-replacements global-map
    "C-c P" `("Elpaca" . ,elpaca-prefix-map))

  (which-key-add-keymap-based-replacements elpaca-prefix-map
    "f" `("Fetch" . ,elpaca-fetch-prefix-map)
    "F" `("Pull" . ,elpaca-pull-prefix-map))
#+end_src
